name: Build ImmortalWrt H5000M

on:
  workflow_dispatch:
    inputs:
      enable_adguardhome:
        description: 'ÂêØÁî® AdGuardHome'
        required: false
        default: false
        type: boolean
      enable_openclash:
        description: 'ÂêØÁî® OpenClash'
        required: false
        default: false
        type: boolean
      enable_nikki:
        description: 'ÂêØÁî® Nikki'
        required: false
        default: false
        type: boolean
      enable_upnp:
        description: 'ÂêØÁî® UPnP'
        required: false
        default: false
        type: boolean
      enable_vlmcsd:
        description: 'ÂêØÁî® VLMCSd'
        required: false
        default: false
        type: boolean
      enable_mosdns:
        description: 'ÂêØÁî® MosDNS'
        required: false
        default: false
        type: boolean
      enable_dockerman:
        description: 'ÂêØÁî® DockerMan'
        required: false
        default: false
        type: boolean
      enable_qmodem_next:
        description: 'ÂêØÁî® QModem Next (Êñ∞Áâà)'
        required: false
        default: false
        type: boolean
      enable_qmodem:
        description: 'ÂêØÁî® QModem (ÊóßÁâà)'
        required: false
        default: false
        type: boolean
      enable_mwan:
        description: 'ÂêØÁî® MWAN (Â§öWANË¥üËΩΩÂùáË°°)'
        required: false
        default: false
        type: boolean
      enable_homeproxy:
        description: 'ÂêØÁî® HomeProxy'
        required: false
        default: false
        type: boolean
      enable_adbyby_plus:
        description: 'ÂêØÁî® Adbyby Plus'
        required: false
        default: false
        type: boolean
      enable_original_modem:
        description: 'ÂêØÁî®ÂéüÁâà Modem'
        required: false
        default: false
        type: boolean
      enable_netspeedtest:
        description: 'ÂêØÁî® netspeedtest'
        required: false
        default: false
        type: boolean
      enable_at_webserver:
        description: 'ÂêØÁî® at-webserver'
        required: false
        default: false
        type: boolean
      enable_zerotier:
        description: 'ÂêØÁî® zerotier'
        required: false
        default: false
        type: boolean
      enable_wrtbwmon:
        description: 'ÂêØÁî® wrtbwmon'
        required: false
        default: false
        type: boolean
      enable_watchcat:
        description: 'ÂêØÁî® watchcat'
        required: false
        default: false
        type: boolean
      enable_easytier:
        description: 'ÂêØÁî® easytier'
        required: false
        default: false
        type: boolean
      enable_lucky:
        description: 'ÂêØÁî® lucky'
        required: false
        default: false
        type: boolean
      enable_bandix:
        description: 'ÂêØÁî® Bandix'
        required: false
        default: false
        type: boolean
      enable_daed:
        description: 'ÂêØÁî® daed'
        required: false
        default: false
        type: boolean
  repository_dispatch:
    types:
      - Source Code Update

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_URL: https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/refs/heads/mt798x-mt799x-6.6-mtwifi/defconfig/mt7987_mt7992.config
  SOURCE_DIR: immortalwrt
  TZ: Asia/Shanghai

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      enable_adguardhome: ${{ steps.set-env.outputs.enable_adguardhome }}
      enable_openclash: ${{ steps.set-env.outputs.enable_openclash }}
      enable_nikki: ${{ steps.set-env.outputs.enable_nikki }}
      enable_upnp: ${{ steps.set-env.outputs.enable_upnp }}
      enable_vlmcsd: ${{ steps.set-env.outputs.enable_vlmcsd }}
      enable_mosdns: ${{ steps.set-env.outputs.enable_mosdns }}
      enable_dockerman: ${{ steps.set-env.outputs.enable_dockerman }}
      enable_qmodem_next: ${{ steps.set-env.outputs.enable_qmodem_next }}
      enable_qmodem: ${{ steps.set-env.outputs.enable_qmodem }}
      enable_mwan: ${{ steps.set-env.outputs.enable_mwan }}
      enable_homeproxy: ${{ steps.set-env.outputs.enable_homeproxy }}
      enable_adbyby_plus: ${{ steps.set-env.outputs.enable_adbyby_plus }}
      enable_original_modem: ${{ steps.set-env.outputs.enable_original_modem }}
      enable_netspeedtest: ${{ steps.set-env.outputs.enable_netspeedtest }}
      enable_at_webserver: ${{ steps.set-env.outputs.enable_at_webserver }}
      enable_zerotier: ${{ steps.set-env.outputs.enable_zerotier }}
      enable_wrtbwmon: ${{ steps.set-env.outputs.enable_wrtbwmon }}
      enable_watchcat: ${{ steps.set-env.outputs.enable_watchcat }}
      enable_easytier: ${{ steps.set-env.outputs.enable_easytier }}
      enable_lucky: ${{ steps.set-env.outputs.enable_lucky }}
      enable_bandix: ${{ steps.set-env.outputs.enable_bandix }}
      enable_daed: ${{ steps.set-env.outputs.enable_daed }}
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ÊÅ¢Â§çÊèí‰ª∂ÈÖçÁΩÆÁºìÂ≠ò
        id: restore-config
        uses: actions/cache/restore@v4
        with:
          path: config/plugins.json
          key: plugins-config-latest
          restore-keys: |
            plugins-config-

      - name: ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
        id: set-env
        run: |
          echo "üîß ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè..."
          
          mkdir -p config
          EVENT_NAME="${{ github.event_name }}"
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "üß≠ ÊâãÂä®Ëß¶ÂèëÔºå‰ºòÂÖà‰ΩøÁî® UI ‰º†ÂÖ•ÁöÑ inputs"
            ENABLE_ADGUARDHOME="${{ github.event.inputs.enable_adguardhome || 'false' }}"
            ENABLE_OPENCLASH="${{ github.event.inputs.enable_openclash || 'false' }}"
            ENABLE_NIKKI="${{ github.event.inputs.enable_nikki || 'false' }}"
            ENABLE_UPNP="${{ github.event.inputs.enable_upnp || 'false' }}"
            ENABLE_VLMCSD="${{ github.event.inputs.enable_vlmcsd || 'false' }}"
            ENABLE_MOSDNS="${{ github.event.inputs.enable_mosdns || 'false' }}"
            ENABLE_DOCKERMAN="${{ github.event.inputs.enable_dockerman || 'false' }}"
            ENABLE_QMODEM_NEXT="${{ github.event.inputs.enable_qmodem_next || 'false' }}"
            ENABLE_QMODEM="${{ github.event.inputs.enable_qmodem || 'false' }}"
            ENABLE_MWAN="${{ github.event.inputs.enable_mwan || 'false' }}"
            ENABLE_HOMEPROXY="${{ github.event.inputs.enable_homeproxy || 'false' }}"
            ENABLE_ADBYBY_PLUS="${{ github.event.inputs.enable_adbyby_plus || 'false' }}"
            ENABLE_ORIGINAL_MODEM="${{ github.event.inputs.enable_original_modem || 'false' }}"
            ENABLE_NETSPEEDTEST="${{ github.event.inputs.enable_netspeedtest || 'false' }}"
            ENABLE_AT_WEBSERVER="${{ github.event.inputs.enable_at_webserver || 'false' }}"
            ENABLE_ZEROTIER="${{ github.event.inputs.enable_zerotier || 'false' }}"
            ENABLE_WRTBWMON="${{ github.event.inputs.enable_wrtbwmon || 'false' }}"
            ENABLE_WATCHCAT="${{ github.event.inputs.enable_watchcat || 'false' }}"
            ENABLE_EASYTIER="${{ github.event.inputs.enable_easytier || 'false' }}"
            ENABLE_LUCKY="${{ github.event.inputs.enable_lucky || 'false' }}"
            ENABLE_BANDIX="${{ github.event.inputs.enable_bandix || 'false' }}"
            ENABLE_DAED="${{ github.event.inputs.enable_daed || 'false' }}"
          else
            if [ -f "config/plugins.json" ]; then
              echo "üìÇ Ëá™Âä®Ëß¶ÂèëÔºåÂèëÁé∞ÁºìÂ≠òÈÖçÁΩÆÔºåËØªÂèñ config/plugins.json"
              # ‰ΩøÁî® Python Ëß£Êûê JSON ‰ª•ÈÅøÂÖç jq ÂÖºÂÆπÊÄßÈóÆÈ¢ò
              eval $(python3 -c 'import json, os
              try:
                  with open("config/plugins.json") as f:
                      data = json.load(f)
                      for k, v in data.items():
                          if k.startswith("enable_"):
                              val = "true" if (v is True or str(v).lower() == "true") else "false"
                              print(f"{k.upper()}={val}")
              except Exception:
                  pass
              ')
            else
              echo "üîÑ Ëá™Âä®Ëß¶Âèë‰∏îÊó†ÁºìÂ≠òÔºå‰ΩøÁî®ÈªòËÆ§Á©∫ÈÖçÁΩÆ"
              # ÈªòËÆ§ÂÖ®‰∏∫ falseÔºåÊó†ÈúÄÈ¢ùÂ§ñÊìç‰ΩúÔºå‰∏ãÊñπÂèòÈáèÊú™ÂÆö‰πâÊó∂ÈªòËÆ§‰∏∫Á©∫ÔºàÊàñÈúÄÊòæÂºèËÆæ‰∏∫ falseÔºâ
            fi
          fi
          
          # Á°Æ‰øùÊâÄÊúâÂèòÈáèÈÉΩÊúâÂÄºÔºàÈªòËÆ§‰∏∫ falseÔºâ
          : ${ENABLE_ADGUARDHOME:=false}
          : ${ENABLE_OPENCLASH:=false}
          : ${ENABLE_NIKKI:=false}
          : ${ENABLE_UPNP:=false}
          : ${ENABLE_VLMCSD:=false}
          : ${ENABLE_MOSDNS:=false}
          : ${ENABLE_DOCKERMAN:=false}
          : ${ENABLE_QMODEM_NEXT:=false}
          : ${ENABLE_QMODEM:=false}
          : ${ENABLE_MWAN:=false}
          : ${ENABLE_HOMEPROXY:=false}
          : ${ENABLE_ADBYBY_PLUS:=false}
          : ${ENABLE_ORIGINAL_MODEM:=false}
          : ${ENABLE_NETSPEEDTEST:=false}
          : ${ENABLE_AT_WEBSERVER:=false}
          : ${ENABLE_ZEROTIER:=false}
          : ${ENABLE_WRTBWMON:=false}
          : ${ENABLE_WATCHCAT:=false}
          : ${ENABLE_EASYTIER:=false}
          : ${ENABLE_LUCKY:=false}
          : ${ENABLE_BANDIX:=false}
          : ${ENABLE_DAED:=false}
          
          # ËæìÂá∫ÈÖçÁΩÆ
          echo "enable_adguardhome=$ENABLE_ADGUARDHOME" >> $GITHUB_OUTPUT
          echo "enable_openclash=$ENABLE_OPENCLASH" >> $GITHUB_OUTPUT
          echo "enable_nikki=$ENABLE_NIKKI" >> $GITHUB_OUTPUT
          echo "enable_upnp=$ENABLE_UPNP" >> $GITHUB_OUTPUT
          echo "enable_vlmcsd=$ENABLE_VLMCSD" >> $GITHUB_OUTPUT
          echo "enable_mosdns=$ENABLE_MOSDNS" >> $GITHUB_OUTPUT
          echo "enable_dockerman=$ENABLE_DOCKERMAN" >> $GITHUB_OUTPUT
          echo "enable_qmodem_next=$ENABLE_QMODEM_NEXT" >> $GITHUB_OUTPUT
          echo "enable_qmodem=$ENABLE_QMODEM" >> $GITHUB_OUTPUT
          echo "enable_mwan=$ENABLE_MWAN" >> $GITHUB_OUTPUT
          echo "enable_homeproxy=$ENABLE_HOMEPROXY" >> $GITHUB_OUTPUT
          echo "enable_adbyby_plus=$ENABLE_ADBYBY_PLUS" >> $GITHUB_OUTPUT
          echo "enable_original_modem=$ENABLE_ORIGINAL_MODEM" >> $GITHUB_OUTPUT
          echo "enable_netspeedtest=$ENABLE_NETSPEEDTEST" >> $GITHUB_OUTPUT
          echo "enable_at_webserver=$ENABLE_AT_WEBSERVER" >> $GITHUB_OUTPUT
          echo "enable_zerotier=$ENABLE_ZEROTIER" >> $GITHUB_OUTPUT
          echo "enable_wrtbwmon=$ENABLE_WRTBWMON" >> $GITHUB_OUTPUT
          echo "enable_watchcat=$ENABLE_WATCHCAT" >> $GITHUB_OUTPUT
          echo "enable_easytier=$ENABLE_EASYTIER" >> $GITHUB_OUTPUT
          echo "enable_lucky=$ENABLE_LUCKY" >> $GITHUB_OUTPUT
          echo "enable_bandix=$ENABLE_BANDIX" >> $GITHUB_OUTPUT
          echo "enable_daed=$ENABLE_DAED" >> $GITHUB_OUTPUT
          
          # ÊòæÁ§∫ÊúÄÁªàÈÖçÁΩÆ
          echo "üìã ÊúÄÁªà‰ΩøÁî®ÁöÑÈÖçÁΩÆ:"
          echo "‚Ä¢ AdGuardHome: $ENABLE_ADGUARDHOME"
          echo "‚Ä¢ OpenClash: $ENABLE_OPENCLASH"
          echo "‚Ä¢ Nikki: $ENABLE_NIKKI"
          echo "‚Ä¢ UPnP: $ENABLE_UPNP"
          echo "‚Ä¢ VLMCSd: $ENABLE_VLMCSD"
          echo "‚Ä¢ MosDNS: $ENABLE_MOSDNS"
          echo "‚Ä¢ DockerMan: $ENABLE_DOCKERMAN"
          echo "‚Ä¢ QModem Next: $ENABLE_QMODEM_NEXT"
          echo "‚Ä¢ QModem: $ENABLE_QMODEM"
          echo "‚Ä¢ MWAN: $ENABLE_MWAN"
          echo "‚Ä¢ HomeProxy: $ENABLE_HOMEPROXY"
          echo "‚Ä¢ Adbyby Plus: $ENABLE_ADBYBY_PLUS"
          echo "‚Ä¢ ÂéüÁâà Modem: $ENABLE_ORIGINAL_MODEM"
          echo "‚Ä¢ NetSpeedTest: $ENABLE_NETSPEEDTEST"
          echo "‚Ä¢ AT WebServer: $ENABLE_AT_WEBSERVER"
          echo "‚Ä¢ ZeroTier: $ENABLE_ZEROTIER"
          echo "‚Ä¢ WRtBWMon: $ENABLE_WRTBWMON"
          echo "‚Ä¢ WatchCat: $ENABLE_WATCHCAT"
          echo "‚Ä¢ EasyTier: $ENABLE_EASYTIER"
          echo "‚Ä¢ Lucky: $ENABLE_LUCKY"
          echo "‚Ä¢ Bandix: $ENABLE_BANDIX"
          echo "‚Ä¢ Daed: $ENABLE_DAED"

      - name: ÁîüÊàêÊ†áÂáÜÊï∞ÊçÆÊ∫ê plugins.json
        run: |
          mkdir -p config
          echo "üßæ ÁîüÊàêÊ†áÂáÜ plugins.json (SSOT)"
          CURRENT_JSON=$(cat << 'EOF'
          {
            "enable_adguardhome": "${{ steps.set-env.outputs.enable_adguardhome }}",
            "enable_openclash": "${{ steps.set-env.outputs.enable_openclash }}",
            "enable_nikki": "${{ steps.set-env.outputs.enable_nikki }}",
            "enable_upnp": "${{ steps.set-env.outputs.enable_upnp }}",
            "enable_vlmcsd": "${{ steps.set-env.outputs.enable_vlmcsd }}",
            "enable_mosdns": "${{ steps.set-env.outputs.enable_mosdns }}",
            "enable_dockerman": "${{ steps.set-env.outputs.enable_dockerman }}",
            "enable_qmodem_next": "${{ steps.set-env.outputs.enable_qmodem_next }}",
            "enable_qmodem": "${{ steps.set-env.outputs.enable_qmodem }}",
            "enable_mwan": "${{ steps.set-env.outputs.enable_mwan }}",
            "enable_homeproxy": "${{ steps.set-env.outputs.enable_homeproxy }}",
            "enable_adbyby_plus": "${{ steps.set-env.outputs.enable_adbyby_plus }}",
            "enable_original_modem": "${{ steps.set-env.outputs.enable_original_modem }}",
            "enable_netspeedtest": "${{ steps.set-env.outputs.enable_netspeedtest }}",
            "enable_at_webserver": "${{ steps.set-env.outputs.enable_at_webserver }}",
            "enable_zerotier": "${{ steps.set-env.outputs.enable_zerotier }}",
            "enable_wrtbwmon": "${{ steps.set-env.outputs.enable_wrtbwmon }}",
            "enable_watchcat": "${{ steps.set-env.outputs.enable_watchcat }}",
            "enable_easytier": "${{ steps.set-env.outputs.enable_easytier }}",
            "enable_lucky": "${{ steps.set-env.outputs.enable_lucky }}",
            "enable_bandix": "${{ steps.set-env.outputs.enable_bandix }}",
            "enable_daed": "${{ steps.set-env.outputs.enable_daed }}"
          }
          EOF
          )
          echo "$CURRENT_JSON" | jq '
            with_entries(select(.key | startswith("enable_"))
            | .value = (
                if (.value|type)=="string" then 
                  (.value | ascii_downcase == "true")
                else 
                  .value 
                end
              )
            )' > config/plugins.json
          echo "‚úÖ plugins.json Â∑≤ÁîüÊàê"
          cat config/plugins.json

      - name: ÁéØÂ¢ÉÂáÜÂ§áÂíåÁºìÂ≠òËÆæÁΩÆ
        run: |
          echo "üîß ÂáÜÂ§áÊûÑÂª∫ÁéØÂ¢É..."

          # Âü∫Á°ÄÊ∏ÖÁêÜ
          sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
          docker system prune -f 2>/dev/null || true

          # Ê£ÄÊü•Á£ÅÁõòÁ©∫Èó¥
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "üíæ ÂèØÁî®Á£ÅÁõòÁ©∫Èó¥: ${AVAIL_GB}GB"

          if [ "$AVAIL_GB" -lt 6 ]; then
            echo "‚ùå Á£ÅÁõòÁ©∫Èó¥‰∏çË∂≥ÔºåÈúÄË¶ÅËá≥Â∞ë6GB"
            exit 1
          fi

          # ÂÆâË£ÖÂøÖË¶Å‰æùËµñ
          sudo apt-get update -qq
          sudo apt-get install -y build-essential git ccache python3 python3-pip \
            libncurses5-dev libssl-dev libgmp3-dev libmbedtls-dev rustc cargo \
            golang-go autoconf automake libtool patch make gcc g++ jq \
            clang llvm npm

          # ËÆæÁΩÆ ccache
          echo "üì¶ ËÆæÁΩÆ ccache..."
          export PATH="/usr/lib/ccache:$PATH"
          ccache --version || true

      - name: ÊÅ¢Â§çÊûÑÂª∫ÁºìÂ≠ò
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir
            ~/.ccache
          key: ${{ runner.os }}-build-${{ env.REPO_BRANCH }}-${{ hashFiles('feeds.conf.default', 'h5000m.extra.config') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.REPO_BRANCH }}-

      - name: Ê∫êÁ†ÅÂíå‰æùËµñÂáÜÂ§á
        run: |
          # Ë∞ÉËØïÔºöÊ£ÄÊü• config ÁõÆÂΩï
          echo "üîç Ë∞ÉËØïÔºöÊ£ÄÊü• config ÁõÆÂΩï"
          ls -R "$GITHUB_WORKSPACE/config" || echo "config ÁõÆÂΩï‰∏çÂ≠òÂú®"

          # Ê£ÄÊü•Âπ∂ÂáÜÂ§áÊ∫êÁ†Å
          if [ ! -d "$SOURCE_DIR" ] || [ ! -d "$SOURCE_DIR/.git" ]; then
            echo "üì• ÂÖãÈöÜÊ∫êÁ†Å..."
            rm -rf "$SOURCE_DIR" 2>/dev/null || true
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
          else
            echo "üîÑ Ê£ÄÊü•Ê∫êÁ†ÅÊõ¥Êñ∞..."
            cd $SOURCE_DIR
            CURRENT_BRANCH=$(git branch --show-current)
            if [ "$CURRENT_BRANCH" != "$REPO_BRANCH" ]; then
              echo "ÂàÜÊîØ‰∏çÂêåÔºåÈáçÊñ∞ÂÖãÈöÜ..."
              cd ..
              rm -rf "$SOURCE_DIR"
              git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
            else
              git fetch origin $REPO_BRANCH
              LOCAL_COMMIT=$(git rev-parse HEAD)
              REMOTE_COMMIT=$(git rev-parse FETCH_HEAD)
              if [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
                echo "ÊúâÊõ¥Êñ∞ÔºåÈáçÁΩÆÂà∞ÊúÄÊñ∞..."
                git reset --hard FETCH_HEAD
              else
                echo "Ê∫êÁ†ÅÂ∑≤ÊòØÊúÄÊñ∞"
              fi
            fi
            cd ..
          fi

          # ËÆæÁΩÆ feeds
          cd $SOURCE_DIR
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
          fi

          # Âä®ÊÄÅÁÆ°ÁêÜ feeds.conf.default (ÂøÖÈ°ªÂú®Ê∏ÖÁêÜÂíåÊõ¥Êñ∞‰πãÂâçÂÆåÊàê)
          # ‰ΩøÁî® Python Ëß£ÊûêÈÅøÂÖç jq ÈóÆÈ¢ò
          NIKKI_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_nikki", False))' 2>/dev/null || echo 'False')
          if [ "$NIKKI_ENABLED" != "True" ] && [ "$NIKKI_ENABLED" != "true" ]; then
            echo "üîß Á¶ÅÁî® nikki feed..."
            sed -i '/src-git nikki/d' feeds.conf.default
            sed -i '/nikki/d' feeds.conf.default
          fi

          # QModem feed
          QN_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_qmodem_next", False))' 2>/dev/null || echo 'False')
          Q_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_qmodem", False))' 2>/dev/null || echo 'False')
          
          # ÂΩí‰∏ÄÂåñÂà§Êñ≠
          if [[ "$QN_ENABLED" != "True" && "$QN_ENABLED" != "true" ]] && [[ "$Q_ENABLED" != "True" && "$Q_ENABLED" != "true" ]]; then
            echo "üîß Á¶ÅÁî® qmodem feed..."
            sed -i '/qmodem/d' feeds.conf.default
          fi

          # Adbyby Plus Áé∞Âú®ÈÄöËøáÁõ¥Êé• clone ‰ªìÂ∫ìÂÆâË£ÖÔºå‰∏çÂÜç‰ΩøÁî® feed

          # ÊòæÁ§∫ÊúÄÁªàÁöÑ feeds.conf.default ÂÜÖÂÆπ
          echo "üìã ÂΩìÂâç feeds.conf.default ÂÜÖÂÆπ:"
          cat feeds.conf.default

          # Ê∏ÖÁêÜ feeds ÁºìÂ≠ò
          echo "üßπ Ê∏ÖÁêÜ feeds ÁºìÂ≠ò..."
          rm -rf tmp/.config* tmp/.packageinfo tmp/.targetinfo tmp/info tmp/.feeds* 2>/dev/null || true
          
          # Ê∏ÖÁêÜÁ¶ÅÁî®ÁöÑ feeds
          [ "$NIKKI_ENABLED" != "true" ] && rm -rf feeds/nikki* package/feeds/nikki 2>/dev/null || true
          [ "$QN_ENABLED" != "true" ] && [ "$Q_ENABLED" != "true" ] && rm -rf feeds/qmodem* package/feeds/qmodem 2>/dev/null || true

          # feeds update/install
          echo "üîÑ Êõ¥Êñ∞ feeds..."
          ./scripts/feeds update -a -j $(nproc) || true
          ./scripts/feeds install -a -f -j $(nproc) || true
          
          echo "‚úÖ feeds Â§ÑÁêÜÂÆåÊàê"

      - name: ÂÖãÈöÜÁ¨¨‰∏âÊñπ‰ªìÂ∫ì
        run: |
          cd $SOURCE_DIR
          echo "üì• ÂÖãÈöÜÁ¨¨‰∏âÊñπ‰ªìÂ∫ì..."
          
          # NetSpeedTest
          NST_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_netspeedtest", False))' 2>/dev/null || echo 'False')
          if [[ "$NST_ENABLED" == "True" || "$NST_ENABLED" == "true" ]] && [ ! -d "package/luci-app-netspeedtest" ]; then
            echo "üì• ÂÖãÈöÜ netspeedtest ‰ªìÂ∫ì..."
            git clone https://github.com/sirpdboy/luci-app-netspeedtest.git -b master package/luci-app-netspeedtest
            if [ $? -ne 0 ]; then
              echo "‚ùå netspeedtest ‰ªìÂ∫ìÂÖãÈöÜÂ§±Ë¥•"
              exit 1
            fi
          fi
          
          # AT WebServer
          AT_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_at_webserver", False))' 2>/dev/null || echo 'False')
          if [[ "$AT_ENABLED" == "True" || "$AT_ENABLED" == "true" ]] && [ ! -d "package/luci-app-at-webserver" ]; then
            echo "üì• ÂÖãÈöÜ at-webserver ‰ªìÂ∫ì..."
            git clone https://github.com/inotdream/mt5700webui-openwrt-server.git -b main package/luci-app-at-webserver
            if [ $? -ne 0 ]; then
              echo "‚ùå at-webserver ‰ªìÂ∫ìÂÖãÈöÜÂ§±Ë¥•"
              exit 1
            fi
          fi
          
          # Lucky
          LUCKY_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_lucky", False))' 2>/dev/null || echo 'False')
          if [[ "$LUCKY_ENABLED" == "True" || "$LUCKY_ENABLED" == "true" ]] && [ ! -d "package/luci-app-lucky" ]; then
            echo "üì• ÂÖãÈöÜ lucky ‰ªìÂ∫ì..."
            git clone https://github.com/gdy666/luci-app-lucky.git -b main package/luci-app-lucky
            if [ $? -ne 0 ]; then
              echo "‚ùå lucky ‰ªìÂ∫ìÂÖãÈöÜÂ§±Ë¥•"
              exit 1
            fi
          fi
          
          # Daed
          DAED_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_daed", False))' 2>/dev/null || echo 'False')
          if [[ "$DAED_ENABLED" == "True" || "$DAED_ENABLED" == "true" ]] && [ ! -d "package/dae" ]; then
            echo "üì• ÂÖãÈöÜ daed ‰ªìÂ∫ì..."
            git clone https://github.com/QiuSimons/luci-app-daed.git package/dae
            if [ $? -ne 0 ]; then
              echo "‚ùå daed ‰ªìÂ∫ìÂÖãÈöÜÂ§±Ë¥•"
              exit 1
            fi
            # ÂÆâË£Ö pnpm (ÁºñËØëÂâçÁ´ØÁïåÈù¢ÈúÄË¶Å)
            sudo npm install -g pnpm
          fi

      - name: ‰∏ãËΩΩ Release ËΩØ‰ª∂ÂåÖÂπ∂ÂáÜÂ§áËá™Âä®ÂÆâË£Ö
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd $SOURCE_DIR
          # Ê†áÂáÜÂåñ files ÁõÆÂΩïÁªìÊûÑ
          INSTALL_DIR="files/root/ipks"
          mkdir -p $INSTALL_DIR
          mkdir -p files/etc/uci-defaults
          mkdir -p files/etc/config
          mkdir -p files/etc/init.d
          mkdir -p files/usr/bin
          mkdir -p files/usr/lib
          
          echo "‚úÖ files ÁõÆÂΩïÁªìÊûÑÊ†áÂáÜÂåñÂÆåÊàê"

          # --- ‰∏ãËΩΩ EasyTier ---
          ET_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_easytier", False))' 2>/dev/null || echo 'False')
          if [[ "$ET_ENABLED" == "True" || "$ET_ENABLED" == "true" ]]; then
            echo "üì• Ëé∑Âèñ EasyTier Release URL..."
            # ‰ΩøÁî® jq ËøõË°åÁ®≥ÂÅ•ÁöÑ JSON Ëß£Êûê
            # Âè™ÈÄâÊã©ÂåÖÂê´ aarch64_cortex-a53 Âíå 22.03.7 ÁöÑÈùû SNAPSHOT ÁâàÊú¨
            ET_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/EasyTier/luci-app-easytier/releases/latest | jq -r '.assets[] | select(.name | contains("aarch64_cortex-a53") and contains("22.03.7") and (contains("SNAPSHOT") | not)).browser_download_url // empty' | head -1)
            # Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂÆåÂÖ®ÂåπÈÖçÁöÑÁâàÊú¨ÔºåÂàô‰ΩøÁî®ÂåÖÂê´ aarch64_cortex-a53 ÁöÑÁâàÊú¨
            if [ -z "$ET_URL" ] || [ "$ET_URL" = "null" ] || [ "$ET_URL" = "" ]; then
              ET_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/EasyTier/luci-app-easytier/releases/latest | jq -r '.assets[] | select(.name | contains("aarch64_cortex-a53") and (contains("SNAPSHOT") | not)).browser_download_url // empty' | head -1)
            fi
            if [ -n "$ET_URL" ] && [ "$ET_URL" != "null" ] && [ "$ET_URL" != "" ]; then
              echo "Ê≠£Âú®‰∏ãËΩΩ: $ET_URL"
              wget -qO /tmp/easytier.zip "$ET_URL"
              # Ê£ÄÊü•‰∏ãËΩΩÁªìÊûú
              if [ -f "/tmp/easytier.zip" ] && [ "$(stat -c %s "/tmp/easytier.zip")" -gt 1024 ]; then
                unzip -o /tmp/easytier.zip -d $INSTALL_DIR/
                # Ê£ÄÊü•Ëß£ÂéãÁªìÊûú
                IPK_FILES=$(ls -la "$INSTALL_DIR"/easytier*.ipk 2>/dev/null | wc -l)
                if [ "$IPK_FILES" -gt 0 ]; then
                  echo "‚úÖ EasyTier ‰∏ãËΩΩÂπ∂Ëß£ÂéãÊàêÂäü"
                else
                  echo "‚ùå EasyTier Ëß£ÂéãÂ§±Ë¥•"
                  exit 1
                fi
              else
                echo "‚ùå EasyTier ‰∏ãËΩΩÂ§±Ë¥•"
                exit 1
              fi
            else
              echo "‚ùå Êó†Ê≥ïËé∑Âèñ EasyTier ‰∏ãËΩΩÂú∞ÂùÄÔºåËØ∑Ê£ÄÊü•‰ªìÂ∫ì Release ÂêçÁß∞"
              exit 1
            fi
          fi

          # --- ‰∏ãËΩΩ Bandix ---
          if [ "$(jq -r '.enable_bandix // false' "$GITHUB_WORKSPACE/config/plugins.json")" = "true" ]; then
            echo "üì• Ëé∑Âèñ Bandix Release URL..."
            # ‰ΩøÁî® jq ËøõË°åÁ®≥ÂÅ•ÁöÑ JSON Ëß£Êûê
            # Ê†∏ÂøÉÂåÖÔºöÂåπÈÖçÂåÖÂê´ bandix Âíå aarch64_cortex-a53 ÁöÑ .ipk Êñá‰ª∂
            BD_CORE_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/timsaya/openwrt-bandix/releases/latest | jq -r '.assets[] | select(.name | contains("bandix") and contains("aarch64_cortex-a53") and contains(".ipk")).browser_download_url // empty' | head -1)
            # ÂâçÁ´ØÂåÖÔºöÂåπÈÖçÂåÖÂê´ luci-app-bandix ÁöÑ .ipk Êñá‰ª∂
            BD_LUCI_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/timsaya/luci-app-bandix/releases/latest | jq -r '.assets[] | select(.name | contains("luci-app-bandix") and contains(".ipk")).browser_download_url // empty' | head -1)
            # ËØ≠Ë®ÄÂåÖÔºöÂåπÈÖçÂåÖÂê´ luci-i18n-bandix-zh-cn ÁöÑ .ipk Êñá‰ª∂
            BD_I18N_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/timsaya/luci-app-bandix/releases/latest | jq -r '.assets[] | select(.name | contains("luci-i18n-bandix-zh-cn") and contains(".ipk")).browser_download_url // empty' | head -1)
            # ÂêàÂπ∂ÊâÄÊúâ Bandix URL
            BD_LUCI_URLS=""
            [ -n "$BD_LUCI_URL" ] && BD_LUCI_URLS="$BD_LUCI_URLS $BD_LUCI_URL"
            [ -n "$BD_I18N_URL" ] && BD_LUCI_URLS="$BD_LUCI_URLS $BD_I18N_URL"
            
            if [ -n "$BD_CORE_URL" ] && [ "$BD_CORE_URL" != "null" ] && [ "$BD_CORE_URL" != "" ]; then
              echo "Ê≠£Âú®‰∏ãËΩΩ Bandix Ê†∏ÂøÉ: $BD_CORE_URL"
              wget -P $INSTALL_DIR/ "$BD_CORE_URL"
              # Ê£ÄÊü•‰∏ãËΩΩÁªìÊûú
              CORE_FILE=$(basename "$BD_CORE_URL")
              if [ -f "$INSTALL_DIR/$CORE_FILE" ] && [ "$(stat -c %s "$INSTALL_DIR/$CORE_FILE")" -gt 1024 ]; then
                echo "‚úÖ Bandix Ê†∏ÂøÉ‰∏ãËΩΩÊàêÂäü"
              else
                echo "‚ùå Bandix Ê†∏ÂøÉ‰∏ãËΩΩÂ§±Ë¥•"
                exit 1
              fi
              
              # ‰∏ãËΩΩ LuCI ÁïåÈù¢ÂíåËØ≠Ë®ÄÂåÖ
              if [ -n "$BD_LUCI_URLS" ] && [ "$BD_LUCI_URLS" != "" ]; then
                echo "Ê≠£Âú®‰∏ãËΩΩ Bandix LuCI ÂåÖ..."
                echo "$BD_LUCI_URLS" | xargs -n 1 wget -P $INSTALL_DIR/
                # Ê£ÄÊü•‰∏ãËΩΩÁªìÊûú
                LUCI_FILES=$(ls -la "$INSTALL_DIR"/luci-app-bandix*.ipk 2>/dev/null | wc -l)
                if [ "$LUCI_FILES" -gt 0 ]; then
                  echo "‚úÖ Bandix LuCI ÂåÖ‰∏ãËΩΩÊàêÂäü"
                else
                  echo "‚ùå Bandix LuCI ÂåÖ‰∏ãËΩΩÂ§±Ë¥•"
                  exit 1
                fi
              else
                echo "‚ö†Ô∏è  Êó†Ê≥ïËé∑Âèñ Bandix LuCI ÂåÖÂú∞ÂùÄÔºåË∑≥Ëøá‰∏ãËΩΩ"
              fi
            else
              echo "‚ùå Êó†Ê≥ïËé∑Âèñ Bandix ‰∏ãËΩΩÂú∞ÂùÄÔºåÂèØËÉΩÊòØ GitHub API ÈôêÂà∂Êàñ‰ªìÂ∫ìÊó†ÂèëÂ∏ÉÁâàÊú¨"
              exit 1
            fi
          fi

          # --- ÂàõÂª∫Ëá™Âä®ÂÆâË£ÖËÑöÊú¨ ---
          cat > files/etc/uci-defaults/99-install-custom-ipks << 'EOF'
          #!/bin/sh
          if [ -d "/root/ipks" ]; then
            # ‰ºòÂÖàÂÆâË£ÖÊ†∏ÂøÉ‰æùËµñÔºåÂÜçÂÆâË£ÖÁïåÈù¢
            opkg install /root/ipks/easytier*.ipk
            opkg install /root/ipks/bandix*.ipk
            opkg install /root/ipks/luci-app-*.ipk
            opkg install /root/ipks/luci-i18n-*.ipk
            rm -rf /root/ipks
          fi
          exit 0
          EOF
          chmod +x files/etc/uci-defaults/99-install-custom-ipks

      - name: Êèí‰ª∂ÈÖçÁΩÆÂÖ≥ËÅî
        run: |
          cd $SOURCE_DIR
          touch features.config
          
          # ÈÄªËæëÁªü‰∏ÄÔºöÂºÄÂêØÊèí‰ª∂Êó∂ÔºåÂº∫Âà∂ÂÖ≥ËÅîÂºÄÂêØ‰æùËµñ
          if [ "$(jq -r '.enable_bandix // false' "$GITHUB_WORKSPACE/config/plugins.json")" = "true" ]; then
              echo "CONFIG_PACKAGE_zoneinfo-all=y" >> features.config
              echo "CONFIG_PACKAGE_zoneinfo-core=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-tun=y" >> features.config
              echo "CONFIG_PACKAGE_libstdcpp=y" >> features.config
              echo "CONFIG_PACKAGE_libpthread=y" >> features.config
              echo "CONFIG_PACKAGE_librt=y" >> features.config
          fi
          
          if [ "$(jq -r '.enable_easytier // false' "$GITHUB_WORKSPACE/config/plugins.json")" = "true" ]; then
              echo "CONFIG_PACKAGE_kmod-tun=y" >> features.config
              echo "CONFIG_PACKAGE_libstdcpp=y" >> features.config
              echo "CONFIG_PACKAGE_libpthread=y" >> features.config
              echo "CONFIG_PACKAGE_librt=y" >> features.config
          fi
          
          if [ "$(jq -r '.enable_daed // false' "$GITHUB_WORKSPACE/config/plugins.json")" = "true" ]; then
              # ËΩØ‰ª∂ÂåÖÈÖçÁΩÆ
              echo "CONFIG_PACKAGE_luci-app-daed=y" >> features.config
              echo "CONFIG_PACKAGE_luci-i18n-daed-zh-cn=y" >> features.config
              # ÂÜÖÊ†∏ eBPF ÊîØÊåÅÈÖçÁΩÆ
              echo "CONFIG_DEVEL=y" >> features.config
              echo "CONFIG_KERNEL_DEBUG_INFO=y" >> features.config
              echo "CONFIG_KERNEL_DEBUG_INFO_REDUCED=n" >> features.config
              echo "CONFIG_KERNEL_DEBUG_INFO_BTF=y" >> features.config
              echo "CONFIG_KERNEL_CGROUPS=y" >> features.config
              echo "CONFIG_KERNEL_CGROUP_BPF=y" >> features.config
              echo "CONFIG_KERNEL_BPF_EVENTS=y" >> features.config
              echo "CONFIG_BPF_TOOLCHAIN_HOST=y" >> features.config
              echo "CONFIG_KERNEL_XDP_SOCKETS=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-xdp-sockets-diag=y" >> features.config
          fi
          
          if [ "$(jq -r '.enable_nikki // false' "$GITHUB_WORKSPACE/config/plugins.json")" = "true" ]; then
              echo "CONFIG_PACKAGE_nikki=y" >> features.config
              echo "CONFIG_PACKAGE_luci-app-nikki=y" >> features.config
              echo "CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y" >> features.config
              echo "CONFIG_PACKAGE_ca-bundle=y" >> features.config
              echo "CONFIG_PACKAGE_curl=y" >> features.config
              echo "CONFIG_PACKAGE_yq=y" >> features.config
              echo "CONFIG_PACKAGE_firewall4=y" >> features.config
              echo "CONFIG_PACKAGE_ip-full=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-inet-diag=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-nft-socket=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-nft-tproxy=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-tun=y" >> features.config
          fi
          
          echo "‚úÖ Êèí‰ª∂ÈÖçÁΩÆÂÖ≥ËÅîÂÆåÊàê"
          cat features.config

      - name: ‰øÆÂ§ç‰æùËµñÂíåË°•‰∏Å
        run: |
          cd $SOURCE_DIR
          echo "üîß Â∫îÁî®Ë°•‰∏ÅÂíå‰øÆÂ§ç‰æùËµñ..."
          
          # ‚≠ê ‰øÆÂ§ç ebtables ‰∏ãËΩΩÈóÆÈ¢ò (ÈïúÂÉèÁ´ôÊñá‰ª∂ÂìàÂ∏å‰∏çÂåπÈÖç)
          EBTABLES_MAKEFILE="package/network/utils/ebtables/Makefile"
          if [ -f "$EBTABLES_MAKEFILE" ]; then
            echo "üîß ‰øÆÂ§ç ebtables ‰∏ãËΩΩÊ∫êÂíåÂìàÂ∏å..."
            # ‰ΩøÁî® netfilter ÂÆòÊñπ GitHub ÈïúÂÉè
            sed -i 's|https://git.netfilter.org/ebtables|https://github.com/netfilter/ebtables.git|g' "$EBTABLES_MAKEFILE"
            sed -i 's|git://git.netfilter.org/ebtables|https://github.com/netfilter/ebtables.git|g' "$EBTABLES_MAKEFILE"
            # Êõ¥Êñ∞ÂìàÂ∏åÂÄº‰∏∫ÈïúÂÉèÁ´ôÂÆûÈôÖÊèê‰æõÁöÑÊñá‰ª∂ÂìàÂ∏å (Ëß£ÂÜ≥ÂìàÂ∏å‰∏çÂåπÈÖçÈóÆÈ¢ò)
            sed -i 's|PKG_MIRROR_HASH:=.*|PKG_MIRROR_HASH:=skip|g' "$EBTABLES_MAKEFILE"
            echo "‚úÖ ebtables ‰∏ãËΩΩÊ∫êÂ∑≤‰øÆÂ§ç"
          fi
          
          # ‚≠ê ‰øÆÂ§ç QMI WWAN È©±Âä® Linux 6.6 ÂÖºÂÆπÊÄß (ÊâÄÊúâÂéÇÂïÜÈ©±Âä®)
          fix_qmi_driver() {
            local SOURCE_FILE="$1"
            if [ -f "$SOURCE_FILE" ]; then
              echo "üîß ‰øÆÂ§çÈ©±Âä®: $SOURCE_FILE"
              
              # ‰øÆÂ§ç u64_stats API ÂèòÊõ¥ (Linux 6.x ÁßªÈô§‰∫Ü _irq ÂêéÁºÄ)
              sed -i 's/u64_stats_fetch_begin_irq/u64_stats_fetch_begin/g' "$SOURCE_FILE"
              sed -i 's/u64_stats_fetch_retry_irq/u64_stats_fetch_retry/g' "$SOURCE_FILE"
              
              # ‰øÆÂ§ç dev_addr Âè™ËØªÈóÆÈ¢ò (Linux 5.15+ dev_addr Âèò‰∏∫ const)
              # ÊñπÊ≥ï1: ‰ΩøÁî® eth_hw_addr_set (Êé®Ëçê)
              if grep -q 'memcpy.*qmap_net->dev_addr.*real_dev->dev_addr' "$SOURCE_FILE"; then
                sed -i 's/memcpy[[:space:]]*(qmap_net->dev_addr,[[:space:]]*real_dev->dev_addr,[[:space:]]*ETH_ALEN);/eth_hw_addr_set(qmap_net, real_dev->dev_addr);/g' "$SOURCE_FILE"
              fi
              # ÊñπÊ≥ï2: Â§ÑÁêÜÂÖ∂‰ªñÂèØËÉΩÁöÑ memcpy Âà∞ dev_addr ÁöÑÊÉÖÂÜµ
              if grep -q 'memcpy.*->dev_addr' "$SOURCE_FILE"; then
                # ‰ΩøÁî® dev_addr_set ‰Ωú‰∏∫Â§áÁî®ÊñπÊ°à
                sed -i 's/memcpy[[:space:]]*(\([^,]*\)->dev_addr,[[:space:]]*\([^,]*\),[[:space:]]*ETH_ALEN);/dev_addr_set(\1, \2);/g' "$SOURCE_FILE" 2>/dev/null || true
              fi
              
              echo "‚úÖ È©±Âä®‰øÆÂ§çÂÆåÊàê: $SOURCE_FILE"
            fi
          }
          
          # ‰øÆÂ§ç Fibocom QMI WWAN È©±Âä®
          fix_qmi_driver "package/mtk/applications/5g-modem/fibocom_QMI_WWAN/qmi_wwan_f.c"
          fix_qmi_driver "package/mtk/applications/5g-modem/fibocom_QMI_WWAN/src/qmi_wwan_f.c"
          
          # ‰øÆÂ§ç Quectel QMI WWAN È©±Âä® (Â¶ÇÊûúÂ≠òÂú®)
          fix_qmi_driver "package/mtk/applications/5g-modem/quectel_QMI_WWAN/qmi_wwan_q.c"
          fix_qmi_driver "package/mtk/applications/5g-modem/quectel_QMI_WWAN/src/qmi_wwan_q.c"
          
          # ‰øÆÂ§ç Simcom QMI WWAN È©±Âä® (Â¶ÇÊûúÂ≠òÂú®)
          fix_qmi_driver "package/mtk/applications/5g-modem/simcom_QMI_WWAN/qmi_wwan_s.c"
          fix_qmi_driver "package/mtk/applications/5g-modem/simcom_QMI_WWAN/src/qmi_wwan_s.c"
          
          # ‰øÆÂ§ç feeds ‰∏≠ÁöÑ QModem È©±Âä® (Â¶ÇÊûúÂ≠òÂú®‰∏îÂ∑≤ÂêØÁî®)
          if [ -d "feeds/qmodem" ]; then
            for driver_file in $(find feeds/qmodem -name "*.c" -type f 2>/dev/null | xargs grep -l "u64_stats_fetch_begin_irq\|memcpy.*dev_addr" 2>/dev/null || true); do
              fix_qmi_driver "$driver_file"
            done
          fi
          
          # ‰∏ãËΩΩÈ¢ùÂ§ñÂåÖ
          AGH_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_adguardhome", False))' 2>/dev/null || echo 'False')
          if [[ "$AGH_ENABLED" == "True" || "$AGH_ENABLED" == "true" ]]; then
            [ ! -d "package/luci-app-adguardhome" ] && \
              git clone --depth=1 https://github.com/kongfl888/luci-app-adguardhome.git package/luci-app-adguardhome
            
            AGH_LUCI_SCRIPT="package/luci-app-adguardhome/root/usr/share/AdGuardHome/links.sh"
            if [ -f "$AGH_LUCI_SCRIPT" ]; then
              sed -i 's|mv /usr/bin/AdGuardHome/AdGuardHome|rm -rf /usr/bin/AdGuardHome 2>/dev/null; mkdir -p /usr/bin/AdGuardHome; mv /tmp/AdGuardHomeupdate/AdGuardHome_linux_*/AdGuardHome|g' "$AGH_LUCI_SCRIPT" || true
            fi
            
            AGH_LUCI_INIT="package/luci-app-adguardhome/root/etc/init.d/AdGuardHome"
            if [ -f "$AGH_LUCI_INIT" ]; then
              sed -i '/^#!/a\
            [ -f /usr/bin/AdGuardHome ] && rm -f /usr/bin/AdGuardHome && mkdir -p /usr/bin/AdGuardHome' "$AGH_LUCI_INIT" || true
            fi
          fi

          # Adbyby Plus Lite ÂÆâË£Ö (‰ªìÂ∫ìÁªìÊûÑ: luci-app-adbyby-plus Â≠êÁõÆÂΩï)
          ADBYBY_ENABLED=$(python3 -c 'import json, os; print(json.load(open(os.environ["GITHUB_WORKSPACE"]+"/config/plugins.json")).get("enable_adbyby_plus", False))' 2>/dev/null || echo 'False')
          if [[ "$ADBYBY_ENABLED" == "True" || "$ADBYBY_ENABLED" == "true" ]]; then
            echo "üîß ÂÆâË£Ö Adbyby Plus Lite..."
            if [ ! -d "package/luci-app-adbyby-plus" ]; then
              git clone --depth=1 --recurse-submodules https://github.com/kongfl888/luci-app-adbyby-plus-lite.git /tmp/adbyby-plus-lite
              cp -r /tmp/adbyby-plus-lite/luci-app-adbyby-plus package/luci-app-adbyby-plus
              rm -rf /tmp/adbyby-plus-lite
            fi
            # Á°Æ‰øù‰æùËµñÂåÖÂ≠òÂú® (ipset Áî®‰∫é Plus+ Ê®°Âºè)
            echo "CONFIG_PACKAGE_ipset=y" >> .config 2>/dev/null || true
            echo "‚úÖ Adbyby Plus Lite ÂÆâË£ÖÂÆåÊàê"
          fi

          # MosDNS ÂÆâË£ÖÊ≠•È™§
          if [ "$(jq -r '.enable_mosdns // false' "$GITHUB_WORKSPACE/config/plugins.json")" = "true" ]; then
            if [ ! -d "feeds/packages/lang/golang" ] || [ ! -f "feeds/packages/lang/golang/Makefile" ]; then
              rm -rf feeds/packages/lang/golang
              git clone https://github.com/sbwml/packages_lang_golang -b 24.x feeds/packages/lang/golang
            fi
            rm -rf feeds/packages/net/v2ray-geodata
            if [ ! -d "package/mosdns" ]; then
              git clone https://github.com/sbwml/luci-app-mosdns -b v5 package/mosdns
            fi
            if [ ! -d "package/v2ray-geodata" ]; then
              git clone https://github.com/sbwml/v2ray-geodata package/v2ray-geodata
            fi
            # Ê∑ªÂä†Ê±âÂåñÂåÖ
            echo "CONFIG_PACKAGE_luci-i18n-mosdns-zh-cn=y" >> .config
          fi
          
          rm -rf package/feeds/packages/{exim,onionshare-cli,python-zope-event,python-zope-interface,python-gevent,python-twisted} 2>/dev/null || true

          # QModem Áõ∏ÂÖ≥‰øÆÂ§ç
          if [ -d "package/feeds/qmodem" ]; then
            rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true
            # ÁßªÈô§ kmod-mhi-wwan ‰æùËµñ
            find . -path "*qmodem*Makefile" -exec sed -i 's/+\?kmod-mhi-wwan//g' {} \; 2>/dev/null || true
          fi

          # ‰øÆÂ§ç mt_hwifi
          [ -f "package/mtk/drivers/mt_hwifi/Makefile" ] && sed -i 's/+kmod-mt_wifi_osal//g' "package/mtk/drivers/mt_hwifi/Makefile" || true

          # È¢ÑË£Ö Clash ÂÜÖÊ†∏
          echo "üîß È¢ÑË£Ö Clash ÂÜÖÊ†∏..."
          # Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫Ü OpenClash
          if [ "$(jq -r '.enable_openclash // false' "$GITHUB_WORKSPACE/config/plugins.json")" = "true" ]; then
            echo "üì¶ ÂÆâË£Ö OpenClash ‰æùËµñ..."
            # Á°Æ‰øù OpenClash ÁõÆÂΩïÂ≠òÂú®
            mkdir -p feeds/luci/applications/luci-app-openclash/root/etc/openclash/core
            core_path="feeds/luci/applications/luci-app-openclash/root/etc/openclash/core"
            goe_path="feeds/luci/applications/luci-app-openclash/root/etc/openclash"
            
            # ‰∏ãËΩΩ Clash Meta ÂÜÖÊ†∏
            CLASH_META_URL="https://raw.githubusercontent.com/vernesong/OpenClash/core/master/meta/clash-linux-arm64.tar.gz"
            GEOIP_URL="https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat"
            GEOSITE_URL="https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat"
            
            echo "üì• ‰∏ãËΩΩ Clash Meta ÂÜÖÊ†∏..."
            wget -qO- $CLASH_META_URL | tar xOvz > $core_path/clash_meta
            echo "üì• ‰∏ãËΩΩ GeoIP Êï∞ÊçÆ..."
            wget -qO- $GEOIP_URL > $goe_path/GeoIP.dat
            echo "üì• ‰∏ãËΩΩ GeoSite Êï∞ÊçÆ..."
            wget -qO- $GEOSITE_URL > $goe_path/GeoSite.dat
            
            # ËÆæÁΩÆÊùÉÈôê
            chmod +x $core_path/clash_meta
            echo "‚úÖ Clash ÂÜÖÊ†∏È¢ÑË£ÖÂÆåÊàê"
            ls -la $core_path/
          else
            echo "‚ö†Ô∏è Êú™ÂêØÁî® OpenClashÔºåË∑≥Ëøá Clash ÂÜÖÊ†∏È¢ÑË£Ö"
          fi

      - name: ‰øÆÊîπÈªòËÆ§LAN IPÂú∞ÂùÄ
        run: |
          cd $SOURCE_DIR
          echo "üîß ‰øÆÊîπÈªòËÆ§LAN IPÂú∞ÂùÄ‰∏∫ 192.168.88.1..."
          
          # ‰ΩøÁî®config_generateËÑöÊú¨ÊñπÊ≥ïÔºàÊúÄÂèØÈù†Ôºâ
          sed -i 's/192.168.6.1/192.168.88.1/g' package/base-files/files/bin/config_generate
          echo "‚úÖ ÈÖçÁΩÆÁîüÊàêËÑöÊú¨Â∑≤‰øÆÊîπÔºåÈªòËÆ§LAN IPÂú∞ÂùÄÂ∑≤ËÆæÁΩÆ‰∏∫ 192.168.88.1"
          cat package/base-files/files/bin/config_generate | grep -E "192\.168\.88\.1" || true

      - name: ÈÖçÁΩÆÊûÑÂª∫
        run: |
          cd $SOURCE_DIR
          echo "‚öôÔ∏è ÈÖçÁΩÆÊûÑÂª∫ÈÄâÈ°π..."

          # ‰ªé plugins.json ËØªÂèñÂºÄÂÖ≥Âπ∂È™åËØÅ‰∫íÊñ•
          CFG="$GITHUB_WORKSPACE/config/plugins.json"
          EN_QN=$(jq -r '.enable_qmodem_next // false' "$CFG")
          EN_Q=$(jq -r '.enable_qmodem // false' "$CFG")
          EN_OM=$(jq -r '.enable_original_modem // false' "$CFG")
          if [ "$EN_QN" = "true" ] && [ "$EN_Q" = "true" ]; then
            echo "‚ùå ÈîôËØØ: ‰∏çËÉΩÂêåÊó∂ÂêØÁî® QModem Next Âíå QModemÔºÅ"
            exit 1
          fi
          if [ "$EN_OM" = "true" ] && [ "$EN_QN" = "true" ]; then
            echo "‚ùå ÈîôËØØ: ‰∏çËÉΩÂêåÊó∂ÂêØÁî®ÂéüÁâà Modem Âíå QModem NextÔºÅ"
            exit 1
          fi
          if [ "$EN_OM" = "true" ] && [ "$EN_Q" = "true" ]; then
            echo "‚ùå ÈîôËØØ: ‰∏çËÉΩÂêåÊó∂ÂêØÁî®ÂéüÁâà Modem Âíå QModemÔºÅ"
            exit 1
          fi

          # ‰∏ãËΩΩÂü∫Á°ÄÈÖçÁΩÆ
          curl -fsSL "$CONFIG_URL" -o base.config || {
            [ -f "defconfig/mt7987_mt7992.config" ] && cp defconfig/mt7987_mt7992.config base.config
          }

          cat base.config > .config

          echo "üîß Âü∫‰∫é plugins.json Âæ™ÁéØÁîüÊàê .config..."
          # ‰ΩøÁî® Python Ëß£Êûê JSON ‰ª•ÈÅøÂÖç jq ÂÖºÂÆπÊÄßÈóÆÈ¢ò
          TRUE_KEYS=$(python3 -c 'import json, os, sys; 
          try:
            cfg_path = os.environ.get("CFG")
            if not cfg_path or not os.path.exists(cfg_path):
                # Â¶ÇÊûú CFG ÁéØÂ¢ÉÂèòÈáè‰∏çÂ≠òÂú®ÊàñÊñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÈªòËÆ§Ë∑ØÂæÑ
                cfg_path = os.path.join(os.environ.get("GITHUB_WORKSPACE"), "config/plugins.json")
            
            if not os.path.exists(cfg_path):
                print(f"Error: Config file not found at {cfg_path}", file=sys.stderr)
                sys.exit(1)

            with open(cfg_path) as f:
              data = json.load(f)
              keys = [k for k, v in data.items() if k.startswith("enable_") and (v is True or str(v).lower() == "true")]
              print(" ".join(keys))
          except Exception as e:
            print(f"JSON Parse Error: {e}", file=sys.stderr)
            sys.exit(1)
          ')
          
          for key in $TRUE_KEYS; do
            name="${key#enable_}"
            case "$name" in
              easytier|bandix)
                echo "‚ÑπÔ∏è $name ÈÄöËøáÁ¶ªÁ∫øÂåÖÂÆâË£ÖÔºåÂÖ≥ËÅî‰æùËµñÂú®ÊûÑÂª∫ÂâçÁΩÆÂ∑≤Â§ÑÁêÜ"
                ;;
              nikki)
                echo "CONFIG_PACKAGE_nikki=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-nikki=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y" >> .config
                echo "CONFIG_PACKAGE_ca-bundle=y" >> .config
                echo "CONFIG_PACKAGE_curl=y" >> .config
                echo "CONFIG_PACKAGE_yq=y" >> .config
                echo "CONFIG_PACKAGE_firewall4=y" >> .config
                echo "CONFIG_PACKAGE_ip-full=y" >> .config
                echo "CONFIG_PACKAGE_kmod-inet-diag=y" >> .config
                echo "CONFIG_PACKAGE_kmod-nft-socket=y" >> .config
                echo "CONFIG_PACKAGE_kmod-nft-tproxy=y" >> .config
                echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
                ;;
              openclash)
                echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
                ;;
              adbyby_plus)
                echo "CONFIG_PACKAGE_luci-app-adbyby-plus=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-adbyby-plus-zh-cn=y" >> .config
                echo "CONFIG_PACKAGE_ipset=y" >> .config
                ;;
              original_modem)
                echo "CONFIG_PACKAGE_luci-app-modem=y" >> .config
                echo "CONFIG_PACKAGE_modem=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-modem-zh-cn=y" >> .config
                ;;
              qmodem_next)
                echo "CONFIG_PACKAGE_luci-app-qmodem-next=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-qmodem-next-zh-cn=y" >> .config
                ;;
              qmodem)
                echo "CONFIG_PACKAGE_luci-app-qmodem=y" >> .config
                echo "CONFIG_PACKAGE_luci-compat=y" >> .config
                echo "CONFIG_PACKAGE_qmodem=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_vendor-qmi-wwan=y" >> .config
                echo "# CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_generic-qmi-wwan is not set" >> .config
                echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_ndisc6=y" >> .config
                echo "# CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_rdisc6 is not set" >> .config
                echo "# CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_no_ndisc_rdisc6 is not set" >> .config
                echo "CONFIG_PACKAGE_ndisc6=y" >> .config
                echo "CONFIG_PACKAGE_quectel-CM-5G-M=y" >> .config
                echo "CONFIG_PACKAGE_sms-tool_q=y" >> .config
                echo "CONFIG_PACKAGE_ubus-at-daemon=y" >> .config
                echo "CONFIG_PACKAGE_tom_modem=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-qmodem-sms=y" >> .config
                echo "CONFIG_PACKAGE_kmod-qmi_wwan_q=y" >> .config
                echo "CONFIG_PACKAGE_kmod-qmi_wwan_f=y" >> .config
                echo "CONFIG_PACKAGE_kmod-qmi_wwan_s=y" >> .config
                ;;
              mwan)
                echo "CONFIG_PACKAGE_mwan3=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
                ;;
              zerotier)
                echo "CONFIG_PACKAGE_zerotier=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-zerotier-zh-cn=y" >> .config
                ;;
              wrtbwmon)
                echo "CONFIG_PACKAGE_wrtbwmon=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-wrtbwmon=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-wrtbwmon-zh-cn=y" >> .config
                ;;
              watchcat)
                echo "CONFIG_PACKAGE_watchcat=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-watchcat=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-watchcat-zh-cn=y" >> .config
                ;;
              netspeedtest)
                echo "CONFIG_PACKAGE_luci-app-netspeedtest=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-netspeedtest-zh-cn=y" >> .config
                ;;
              at_webserver)
                echo "CONFIG_PACKAGE_luci-app-at-webserver=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-at-webserver-zh-cn=y" >> .config
                ;;
              lucky)
                echo "CONFIG_PACKAGE_luci-app-lucky=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-lucky-zh-cn=y" >> .config
                ;;
              adguardhome|mosdns|dockerman|homeproxy|upnp|vlmcsd)
                echo "CONFIG_PACKAGE_luci-app-${name}=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-${name}-zh-cn=y" >> .config || true
                ;;
              *)
                echo "CONFIG_PACKAGE_luci-app-${name}=y" >> .config
                ;;
            esac
          done

          # Â∫îÁî®È¢ùÂ§ñÈÖçÁΩÆ
          if [ -f "$GITHUB_WORKSPACE/h5000m.extra.config" ]; then
            echo "üìÑ Â∫îÁî®È¢ùÂ§ñÈÖçÁΩÆ..."
            cat "$GITHUB_WORKSPACE/h5000m.extra.config" >> .config
          fi

          # Â∑≤ÁßªÈô§ features.config Áã¨Á´ãÊñá‰ª∂ÔºåÁõ∏ÂÖ≥‰æùËµñÂú®‰∏äËø∞Âæ™ÁéØ‰∏≠Â§ÑÁêÜ

          # IPÂú∞ÂùÄ‰øÆÊîπÂ∑≤Âú®ÂâçÈù¢ÁöÑÊ≠•È™§‰∏≠ÂÆåÊàêÔºà‰ΩøÁî®config_generateËÑöÊú¨ÊñπÊ≥ïÔºâ

          # Á°¨ÁºñÁ†ÅÊåáÂÆöÊèí‰ª∂Â∑≤ÁßªËá≥ h5000m.extra.config Êñá‰ª∂

          # Áªü‰∏ÄÁ¶ÅÁî®‰∏çÈúÄË¶ÅÁöÑÂåÖÔºàÂèØÊ†πÊçÆÈúÄË¶ÅË°•ÂÖÖÔºâ
          disabled_pkgs=("luci-app-sms-tool-lite" "luci-app-3ginfo-lite")

          # Áªü‰∏ÄÁ¶ÅÁî®‰∏çÈúÄË¶ÅÁöÑÂåÖ
          all_disabled=("luci-app-wrtbwmon" "luci-app-rclone" "rclone" "rclone-ng" "rclone-webui-react" "${disabled_pkgs[@]}")
          for pkg in "${all_disabled[@]}"; do
            sed -i "/^CONFIG_PACKAGE_${pkg}=/d" .config
            echo "# CONFIG_PACKAGE_${pkg} is not set" >> .config
          done

          # Ëá™Âä®Ëß£Êûê‰æùËµñ
          make defconfig

          echo "‚úÖ ÈÖçÁΩÆÂÆåÊàê"

      - name: È¢Ñ‰∏ãËΩΩÂíåÈ¢ÑÊûÑÂª∫
        run: |
          cd $SOURCE_DIR
          THREADS=$(nproc)
          
          # ‰∏ãËΩΩ‰æùËµñÔºàÂ∏¶ÈáçËØïÔºâ
          echo "üì• È¢Ñ‰∏ãËΩΩÊûÑÂª∫‰æùËµñ..."
          find dl -size -1024c -delete 2>/dev/null || true
          for i in 1 2 3; do
            make download -j$THREADS && break || { find dl -size -1024c -delete 2>/dev/null || true; sleep 3; }
          done
          
          # È¢ÑÊûÑÂª∫Â∑•ÂÖ∑Èìæ
          echo "üîß È¢ÑÊûÑÂª∫Â∑•ÂÖ∑Èìæ..."
          [ -d "staging_dir" ] && [ -n "$(ls -A staging_dir 2>/dev/null)" ] && echo "‚úÖ Â∑•ÂÖ∑ÈìæÂ∑≤ÁºìÂ≠ò" || make toolchain/install -j$THREADS || true

      - name: ÊâìÂåÖÊ∫êÁ†Å
        run: |
          echo "üì¶ ÊâìÂåÖÊ∫êÁ†ÅÂíåÈÖçÁΩÆ..."
          tar --exclude="$SOURCE_DIR/build_dir" --exclude="$SOURCE_DIR/tmp" -czf source.tar.gz $SOURCE_DIR $GITHUB_WORKSPACE/h5000m.extra.config $GITHUB_WORKSPACE/feeds.conf.default 2>/dev/null || true

      - name: ÁºìÂ≠òÊèí‰ª∂ÈÖçÁΩÆ‰øùÂ≠ò
        uses: actions/cache/save@v4
        with:
          path: config/plugins.json
          key: plugins-config-${{ github.run_id }}

      - name: ‰∏ä‰º†ÊûÑÂª∫ÈÖçÁΩÆ Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-configs
          path: config/
          retention-days: 7

      - name: ÁºìÂ≠òÊèí‰ª∂ÈÖçÁΩÆ
        uses: actions/cache@v4
        with:
          path: config/plugins.json
          key: plugins-config-${{ github.run_id }}
          restore-keys: |
            plugins-config-

      - name: ‰∏ä‰º†Ê∫êÁ†Å
        uses: actions/upload-artifact@v4
        with:
          name: source-${{ github.run_number }}
          path: source.tar.gz
          retention-days: 1

  build:
    needs: prepare
    runs-on: ubuntu-22.04
    steps:
      - name: ‰∏ãËΩΩÊûÑÂª∫ÈÖçÁΩÆ
        uses: actions/download-artifact@v4
        with:
          name: build-configs
          path: config

      - name: ‰∏ãËΩΩÊ∫êÁ†Å
        uses: actions/download-artifact@v4
        with:
          name: source-${{ github.run_number }}

      - name: Ëß£ÂéãÊ∫êÁ†Å
        run: |
          echo "üì¶ Ëß£ÂéãÊ∫êÁ†Å..."
          tar -xzf source.tar.gz
          echo "‚úÖ Ê∫êÁ†ÅËß£ÂéãÂÆåÊàê"

      - name: ÂÆâË£ÖÁºñËØë‰æùËµñ
        run: |
          echo "üì¶ ÂÆâË£ÖÁºñËØë‰æùËµñ..."
          sudo apt-get update -qq
          sudo apt-get install -y build-essential git ccache python3 python3-pip \
            libncurses5-dev libssl-dev libgmp3-dev libmbedtls-dev rustc cargo \
            golang-go autoconf automake libtool patch make gcc g++ gawk gettext unzip file wget
          
          # ËÆæÁΩÆ ccache
          export PATH="/usr/lib/ccache:$PATH"
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          echo "‚úÖ ÁºñËØë‰æùËµñÂÆâË£ÖÂÆåÊàê"

      - name: Ê∑±Â∫¶Ê∏ÖÁêÜÁ£ÅÁõòÁ©∫Èó¥
        run: |
          echo "üßπ ÊâßË°åÊ∑±Â∫¶Ê∏ÖÁêÜ‰ª•ÈáäÊîæÁ£ÅÁõòÁ©∫Èó¥..."
          
          # Âà†Èô§ Docker ËµÑÊ∫ê
          docker rmi $(docker images -q) 2>/dev/null || true
          docker system prune -f 2>/dev/null || true
          
          # Âà†Èô§Â§ßÂûãÁªÑ‰ª∂
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php \
            /usr/local/share/boost /usr/share/swift /opt/hostedtoolcache /usr/local/.ghcup \
            /usr/local/graalvm /imagegeneration /usr/local/share /opt /var/cache/apt/archives/* \
            /etc/apt/sources.list.d/* 2>/dev/null || true
          
          # Âç∏ËΩΩ‰∏çÈúÄË¶ÅÁöÑËΩØ‰ª∂ÂåÖ
          sudo apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* \
            google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* \
            mongodb* moby* snap* 2>/dev/null || true
          
          # Ê∏ÖÁêÜÂåÖÁÆ°ÁêÜÂô®Âíå‰∏¥Êó∂Êñá‰ª∂
          sudo apt-get autoremove --purge -y && sudo apt-get clean && sudo apt-get autoclean
          sudo rm -rf /tmp/* /var/tmp/* /var/log/* ~/.cache/* 2>/dev/null || true
          
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "‚úÖ Ê∏ÖÁêÜÂêéÂèØÁî®Á£ÅÁõòÁ©∫Èó¥: ${AVAIL_GB}GB"

      - name: ÁºñËØëÂõ∫‰ª∂
        run: |
          cd $SOURCE_DIR
          THREADS=$(nproc)  # Âä®ÊÄÅ‰ΩøÁî®ÊâÄÊúâÂèØÁî®Ê†∏ÂøÉÔºåÊèêÈ´òÊïàÁéá
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "üî® ÂºÄÂßãÁºñËØë (${THREADS} Á∫øÁ®ã)..."
          echo "üìä CCache ÁªüËÆ° (ÂºÄÂßã):"
          ccache -s || true
          
          START_TIME=$(date +%s)
          
          # Ë°•ÂÖÖ‰∏ãËΩΩÔºàÂ¶ÇÊúâÈÅóÊºèÔºâ
          find dl -size -1024c -delete 2>/dev/null || true
          make download -j$THREADS || true
          
          # ÁºñËØë
          if make -j$THREADS IGNORE_ERRORS=n; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "‚úÖ ÁºñËØëÊàêÂäü (ËÄóÊó∂: ${DURATION}s)"
            echo "üìä CCache ÁªüËÆ° (ÁªìÊùü):"
            ccache -s || true
          else
            echo "‚ö†Ô∏è Âπ∂Ë°åÁºñËØëÂ§±Ë¥•ÔºåÂ∞ùËØïÂçïÁ∫øÁ®ãË∞ÉËØï..."
            make -j1 V=s || {
              echo "‚ùå ÁºñËØëÂ§±Ë¥•"
              exit 1
            }
          fi

      - name: ÊâìÂåÖ‰∫ßÁâ©
        run: |
          cd $SOURCE_DIR
          echo "üì¶ ÊâìÂåÖ‰∫ßÁâ©..."
          mkdir -p ../artifacts
          find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} ../artifacts/ \;
          cd ..
          tar -czf artifacts.tar.gz artifacts/

      - name: Âä®ÊÄÅÁîüÊàêRelease‰ø°ÊÅØ
        run: |
          echo "üîç Ë∞ÉËØïÔºöÊ£ÄÊü• config ÁõÆÂΩï"
          ls -R "$GITHUB_WORKSPACE/config" || echo "config ÁõÆÂΩï‰∏çÂ≠òÂú®"
          
          cd $SOURCE_DIR
          echo "üéâ **ImmortalWrt H5000M Âõ∫‰ª∂Â∑≤ÊûÑÂª∫ÂÆåÊàê**" > release_body.md
          echo "" >> release_body.md
          echo "üìÖ Êó∂Èó¥: ${{ github.event.repository.updated_at }}" >> release_body.md
          echo "üîó ËøêË°å ID: ${{ github.run_id }}" >> release_body.md
          echo "" >> release_body.md
          echo "**‚öôÔ∏è ÂêØÁî®ÁöÑÂäüËÉΩ:**" >> release_body.md
          jq -r '
            to_entries
            | map(select(.key | startswith("enable_") and .value==true))
            | .[].key
            | sub("^enable_"; "")
            | split("_")
            | map(. as $s | ($s[0:1]|ascii_upcase) + $s[1:])
            | join(" ")
            | "- ‚úÖ " + .
          ' "$GITHUB_WORKSPACE/config/plugins.json" >> release_body.md
          echo "" >> release_body.md
          echo "üíæ ‰∏ãËΩΩ‰∫ßÁâ©: ËßÅ‰∏ãÊñπ Artifacts" >> release_body.md
          echo "üìã ËØ¶ÁªÜ‰ø°ÊÅØ: ËßÅ MANIFEST.txt" >> release_body.md
          
          # Â§çÂà∂Âà∞artifactsÁõÆÂΩï
          cp release_body.md ../artifacts/
          echo "‚úÖ Release‰ø°ÊÅØÁîüÊàêÂÆåÊàê"

      - name: È™åËØÅ‰∫ßÁâ©
        run: |
          echo "üîç È™åËØÅ‰∫ßÁâ©..."
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "‚ùå Ê≤°ÊúâÊâæÂà∞‰∫ßÁâ©Êñá‰ª∂"
            exit 1
          else
            echo "‚úÖ ‰∫ßÁâ©È™åËØÅÈÄöËøá"
            ls -lh artifacts/
          fi

      - name: ‰∏ä‰º†‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ github.run_number }}
          path: artifacts.tar.gz
          retention-days: 30

  release:
    needs: [prepare, build]
    runs-on: ubuntu-22.04
    if: success()
    steps:
      - name: ‰∏ãËΩΩÊûÑÂª∫ÈÖçÁΩÆ
        uses: actions/download-artifact@v4
        with:
          name: build-configs
          path: config

      - name: ‰∏ãËΩΩ‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          name: artifacts-${{ github.run_number }}

      - name: Ëß£Âéã‰∫ßÁâ©
        run: |
          echo "üì¶ Ëß£Âéã‰∫ßÁâ©..."
          tar -xzf artifacts.tar.gz
          echo "‚úÖ ‰∫ßÁâ©Ëß£ÂéãÂÆåÊàê"

      - name: Êî∂ÈõÜÂíå‰∏ä‰º†‰∫ßÁâ©
        run: |
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "‚ùå Ê≤°ÊúâÊâæÂà∞‰∫ßÁâ©Êñá‰ª∂"
            exit 1
          fi

          echo "üîç Ë∞ÉËØïÔºöÊ£ÄÊü• config ÁõÆÂΩï"
          ls -R "$GITHUB_WORKSPACE/config" || echo "config ÁõÆÂΩï‰∏çÂ≠òÂú®"

          # ÁîüÊàê Release ‰ø°ÊÅØ
          echo "üéâ **ImmortalWrt H5000M Âõ∫‰ª∂Â∑≤ÊûÑÂª∫ÂÆåÊàê**" > artifacts/release_body.md
          echo "" >> artifacts/release_body.md
          echo "üìÖ Êó∂Èó¥: $(date '+%Y-%m-%d %H:%M:%S')" >> artifacts/release_body.md
          echo "üîó ËøêË°å ID: ${{ github.run_id }}" >> artifacts/release_body.md
          echo "" >> artifacts/release_body.md
          echo "**‚öôÔ∏è ÂêØÁî®ÁöÑÂäüËÉΩ:**" >> artifacts/release_body.md
          jq -r '
            to_entries
            | map(select(.key | startswith("enable_") and .value==true))
            | .[].key
            | sub("^enable_"; "")
            | split("_")
            | map(. as $s | ($s[0:1]|ascii_upcase) + $s[1:])
            | join(" ")
            | "- ‚úÖ " + .
          ' "$GITHUB_WORKSPACE/config/plugins.json" >> artifacts/release_body.md
          
          echo "" >> artifacts/release_body.md
          echo "üíæ ‰∏ãËΩΩ‰∫ßÁâ©: ËßÅ‰∏ãÊñπ Artifacts" >> artifacts/release_body.md
          echo "üìã ËØ¶ÁªÜ‰ø°ÊÅØ: ËßÅ MANIFEST.txt" >> artifacts/release_body.md

          # ÁîüÊàêÊ∏ÖÂçï
          cat > artifacts/MANIFEST.txt << EOF
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë    ImmortalWrt H5000M Âõ∫‰ª∂ÊûÑÂª∫‰ø°ÊÅØ             ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

          üìÖ ÊûÑÂª∫Êó∂Èó¥: $(date '+%Y-%m-%d %H:%M:%S')
          üîó ËøêË°å ID: ${{ github.run_id }}
          üè∑Ô∏è  Build #: ${{ github.run_number }}

          EOF
          
          echo "" >> artifacts/MANIFEST.txt
          echo "üì¶ ‰∫ßÁâ©Êñá‰ª∂:" >> artifacts/MANIFEST.txt

          cd artifacts
          ls -lh | grep -v "^total" | awk '{print "  ‚Ä¢ " $9 " (" $5 ")"}' >> MANIFEST.txt

          echo "‚úÖ ‰∫ßÁâ©Êî∂ÈõÜÂÆåÊàê"

      - name: ‰∏ä‰º†ÊûÑÂª∫ÁªìÊûú
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-H5000M-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: ÂàõÂª∫ GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: h5000m-${{ github.run_number }}
          name: ImmortalWrt H5000M
          body_path: artifacts/release_body.md
          files: |
            artifacts/*.bin
            artifacts/*.img.gz
            artifacts/MANIFEST.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
