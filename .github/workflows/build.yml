name: Build ImmortalWrt H5000M

on:
  workflow_dispatch:
    inputs:
      enable_adguardhome:
        description: 'å¯ç”¨ AdGuardHome'
        required: false
        default: false
        type: boolean
      enable_openclash:
        description: 'å¯ç”¨ OpenClash'
        required: false
        default: false
        type: boolean
      enable_nikki:
        description: 'å¯ç”¨ Nikki'
        required: false
        default: false
        type: boolean
      enable_upnp:
        description: 'å¯ç”¨ UPnP'
        required: false
        default: false
        type: boolean
      enable_vlmcsd:
        description: 'å¯ç”¨ VLMCSd'
        required: false
        default: false
        type: boolean
      enable_mosdns:
        description: 'å¯ç”¨ MosDNS'
        required: false
        default: false
        type: boolean
      enable_dockerman:
        description: 'å¯ç”¨ DockerMan'
        required: false
        default: false
        type: boolean
      enable_qmodem_next:
        description: 'å¯ç”¨ QModem Next (æ–°ç‰ˆ)'
        required: false
        default: false
        type: boolean
      enable_qmodem:
        description: 'å¯ç”¨ QModem (æ—§ç‰ˆ)'
        required: false
        default: false
        type: boolean
      enable_mwan:
        description: 'å¯ç”¨ MWAN (å¤šWANè´Ÿè½½å‡è¡¡)'
        required: false
        default: false
        type: boolean
      enable_homeproxy:
        description: 'å¯ç”¨ HomeProxy'
        required: false
        default: false
        type: boolean
      enable_adbyby_plus:
        description: 'å¯ç”¨ Adbyby Plus'
        required: false
        default: false
        type: boolean
      enable_original_modem:
        description: 'å¯ç”¨åŽŸç‰ˆ Modem'
        required: false
        default: false
        type: boolean
      enable_netspeedtest:
        description: 'å¯ç”¨ netspeedtest'
        required: false
        default: false
        type: boolean
      enable_at_webserver:
        description: 'å¯ç”¨ at-webserver'
        required: false
        default: false
        type: boolean
      enable_zerotier:
        description: 'å¯ç”¨ zerotier'
        required: false
        default: false
        type: boolean
      enable_wrtbwmon:
        description: 'å¯ç”¨ wrtbwmon'
        required: false
        default: false
        type: boolean
      enable_watchcat:
        description: 'å¯ç”¨ watchcat'
        required: false
        default: false
        type: boolean
      enable_easytier:
        description: 'å¯ç”¨ easytier'
        required: false
        default: false
        type: boolean
      enable_lucky:
        description: 'å¯ç”¨ lucky'
        required: false
        default: false
        type: boolean
      enable_bandix:
        description: 'å¯ç”¨ Bandix'
        required: false
        default: false
        type: boolean
      enable_daed:
        description: 'å¯ç”¨ daed'
        required: false
        default: false
        type: boolean
  repository_dispatch:
    types:
      - Source Code Update

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_URL: https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/refs/heads/mt798x-mt799x-6.6-mtwifi/defconfig/mt7987_mt7992.config
  SOURCE_DIR: immortalwrt
  TZ: Asia/Shanghai

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      enable_adguardhome: ${{ steps.set-env.outputs.enable_adguardhome }}
      enable_openclash: ${{ steps.set-env.outputs.enable_openclash }}
      enable_nikki: ${{ steps.set-env.outputs.enable_nikki }}
      enable_upnp: ${{ steps.set-env.outputs.enable_upnp }}
      enable_vlmcsd: ${{ steps.set-env.outputs.enable_vlmcsd }}
      enable_mosdns: ${{ steps.set-env.outputs.enable_mosdns }}
      enable_dockerman: ${{ steps.set-env.outputs.enable_dockerman }}
      enable_qmodem_next: ${{ steps.set-env.outputs.enable_qmodem_next }}
      enable_qmodem: ${{ steps.set-env.outputs.enable_qmodem }}
      enable_mwan: ${{ steps.set-env.outputs.enable_mwan }}
      enable_homeproxy: ${{ steps.set-env.outputs.enable_homeproxy }}
      enable_adbyby_plus: ${{ steps.set-env.outputs.enable_adbyby_plus }}
      enable_original_modem: ${{ steps.set-env.outputs.enable_original_modem }}
      enable_netspeedtest: ${{ steps.set-env.outputs.enable_netspeedtest }}
      enable_at_webserver: ${{ steps.set-env.outputs.enable_at_webserver }}
      enable_zerotier: ${{ steps.set-env.outputs.enable_zerotier }}
      enable_wrtbwmon: ${{ steps.set-env.outputs.enable_wrtbwmon }}
      enable_watchcat: ${{ steps.set-env.outputs.enable_watchcat }}
      enable_easytier: ${{ steps.set-env.outputs.enable_easytier }}
      enable_lucky: ${{ steps.set-env.outputs.enable_lucky }}
      enable_bandix: ${{ steps.set-env.outputs.enable_bandix }}
      enable_daed: ${{ steps.set-env.outputs.enable_daed }}
    steps:
      - name: æ¢å¤æ’ä»¶é…ç½®ç¼“å­˜
        uses: actions/cache/restore@v4
        id: restore-config
        with:
          path: config/plugins.json
          key: plugin-config-${{ github.run_id }}
          restore-keys: |
            plugin-config-

      - name: é€»è¾‘åˆ¤æ–­ï¼šè‡ªåŠ¨ vs æ‰‹åŠ¨
        id: determine-config
        run: |
          echo "ðŸ”§ ç¡®å®šé…ç½®æ¥æº..."
          mkdir -p config
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¨è§¦å‘çš„ inputs
          INPUTS_JSON=$(echo '${{ toJSON(github.event.inputs) }}')
          INPUTS_COUNT=$(echo "$INPUTS_JSON" | jq -r 'to_entries | length')
          
          if [ "$INPUTS_COUNT" -gt 0 ]; then
            echo "ðŸ“± æ£€æµ‹åˆ°æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨ UI å‹¾é€‰çš„ Inputs..."
            # ä½¿ç”¨æ‰‹åŠ¨è§¦å‘çš„ inputs
            echo "$INPUTS_JSON" | jq 'with_entries(select(.key | startswith("enable_")))' > config/plugins.json
          elif [ -f "config/plugins.json" ]; then
            echo "ðŸ“‚ æ£€æµ‹åˆ°è‡ªåŠ¨è§¦å‘ï¼Œä½¿ç”¨ç¼“å­˜çš„æ’ä»¶é…ç½®..."
            # ä½¿ç”¨ç¼“å­˜çš„é…ç½®
            cat config/plugins.json
          else
            echo "ðŸ”„ æ— ç¼“å­˜é…ç½®ï¼Œä½¿ç”¨é»˜è®¤ç©ºé…ç½®..."
            # ä½¿ç”¨é»˜è®¤ç©ºé…ç½®
            echo '{"enable_adguardhome":false,"enable_openclash":false,"enable_nikki":false,"enable_upnp":false,"enable_vlmcsd":false,"enable_mosdns":false,"enable_dockerman":false,"enable_qmodem_next":false,"enable_qmodem":false,"enable_mwan":false,"enable_homeproxy":false,"enable_adbyby_plus":false,"enable_original_modem":false,"enable_netspeedtest":false,"enable_at_webserver":false,"enable_zerotier":false,"enable_wrtbwmon":false,"enable_watchcat":false,"enable_easytier":false,"enable_lucky":false,"enable_bandix":false,"enable_daed":false}' > config/plugins.json
          fi
          
          echo "âœ… é…ç½®æ¥æºç¡®å®šå®Œæˆ"
          echo "ðŸ“‹ å½“å‰é…ç½®:"
          cat config/plugins.json

      - name: ç”Ÿæˆæ ‡å‡†æ•°æ®æº (plugins.json)
        id: generate-config
        run: |
          echo "ðŸ”§ ç”Ÿæˆæ ‡å‡†æ•°æ®æº plugins.json..."
          
          # ä»Žå½“å‰é…ç½®ç”Ÿæˆçº¯å‡€çš„ JSON æ–‡ä»¶ï¼Œä»…åŒ…å«å¼€å…³çŠ¶æ€
          CURRENT_CONFIG=$(echo '${{ toJSON(github.event.inputs) }}')
          if [ -f "config/plugins.json" ]; then
            CURRENT_CONFIG=$(cat config/plugins.json)
          fi
          
          echo "$CURRENT_CONFIG" | jq 'with_entries(select(.key | startswith("enable_")))' > config/plugins.json
          
          echo "âœ… æ ‡å‡†æ•°æ®æºç”Ÿæˆå®Œæˆ"
          cat config/plugins.json

      - name: è®¾ç½®çŽ¯å¢ƒå˜é‡
        id: set-env
        run: |
          echo "ðŸ”§ ä»Ž config/plugins.json è®¾ç½®çŽ¯å¢ƒå˜é‡..."
          
          # ä»Ž config/plugins.json è¯»å–é…ç½®
          ENABLE_ADGUARDHOME=$(jq -r '.enable_adguardhome' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_OPENCLASH=$(jq -r '.enable_openclash' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_NIKKI=$(jq -r '.enable_nikki' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_UPNP=$(jq -r '.enable_upnp' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_VLMCSD=$(jq -r '.enable_vlmcsd' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_MOSDNS=$(jq -r '.enable_mosdns' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_DOCKERMAN=$(jq -r '.enable_dockerman' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_QMODEM_NEXT=$(jq -r '.enable_qmodem_next' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_QMODEM=$(jq -r '.enable_qmodem' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_MWAN=$(jq -r '.enable_mwan' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_HOMEPROXY=$(jq -r '.enable_homeproxy' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_ADBYBY_PLUS=$(jq -r '.enable_adbyby_plus' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_ORIGINAL_MODEM=$(jq -r '.enable_original_modem' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_NETSPEEDTEST=$(jq -r '.enable_netspeedtest' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_AT_WEBSERVER=$(jq -r '.enable_at_webserver' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_ZEROTIER=$(jq -r '.enable_zerotier' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_WRTBWMON=$(jq -r '.enable_wrtbwmon' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_WATCHCAT=$(jq -r '.enable_watchcat' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_EASYTIER=$(jq -r '.enable_easytier' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_LUCKY=$(jq -r '.enable_lucky' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_BANDIX=$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')
          ENABLE_DAED=$(jq -r '.enable_daed' config/plugins.json 2>/dev/null || echo 'false')
          
          # è¾“å‡ºé…ç½®
          echo "enable_adguardhome=$ENABLE_ADGUARDHOME" >> $GITHUB_OUTPUT
          echo "enable_openclash=$ENABLE_OPENCLASH" >> $GITHUB_OUTPUT
          echo "enable_nikki=$ENABLE_NIKKI" >> $GITHUB_OUTPUT
          echo "enable_upnp=$ENABLE_UPNP" >> $GITHUB_OUTPUT
          echo "enable_vlmcsd=$ENABLE_VLMCSD" >> $GITHUB_OUTPUT
          echo "enable_mosdns=$ENABLE_MOSDNS" >> $GITHUB_OUTPUT
          echo "enable_dockerman=$ENABLE_DOCKERMAN" >> $GITHUB_OUTPUT
          echo "enable_qmodem_next=$ENABLE_QMODEM_NEXT" >> $GITHUB_OUTPUT
          echo "enable_qmodem=$ENABLE_QMODEM" >> $GITHUB_OUTPUT
          echo "enable_mwan=$ENABLE_MWAN" >> $GITHUB_OUTPUT
          echo "enable_homeproxy=$ENABLE_HOMEPROXY" >> $GITHUB_OUTPUT
          echo "enable_adbyby_plus=$ENABLE_ADBYBY_PLUS" >> $GITHUB_OUTPUT
          echo "enable_original_modem=$ENABLE_ORIGINAL_MODEM" >> $GITHUB_OUTPUT
          echo "enable_netspeedtest=$ENABLE_NETSPEEDTEST" >> $GITHUB_OUTPUT
          echo "enable_at_webserver=$ENABLE_AT_WEBSERVER" >> $GITHUB_OUTPUT
          echo "enable_zerotier=$ENABLE_ZEROTIER" >> $GITHUB_OUTPUT
          echo "enable_wrtbwmon=$ENABLE_WRTBWMON" >> $GITHUB_OUTPUT
          echo "enable_watchcat=$ENABLE_WATCHCAT" >> $GITHUB_OUTPUT
          echo "enable_easytier=$ENABLE_EASYTIER" >> $GITHUB_OUTPUT
          echo "enable_lucky=$ENABLE_LUCKY" >> $GITHUB_OUTPUT
          echo "enable_bandix=$ENABLE_BANDIX" >> $GITHUB_OUTPUT
          echo "enable_daed=$ENABLE_DAED" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºæœ€ç»ˆé…ç½®
          echo "ðŸ“‹ æœ€ç»ˆä½¿ç”¨çš„é…ç½®:"
          echo "â€¢ AdGuardHome: $ENABLE_ADGUARDHOME"
          echo "â€¢ OpenClash: $ENABLE_OPENCLASH"
          echo "â€¢ Nikki: $ENABLE_NIKKI"
          echo "â€¢ UPnP: $ENABLE_UPNP"
          echo "â€¢ VLMCSd: $ENABLE_VLMCSD"
          echo "â€¢ MosDNS: $ENABLE_MOSDNS"
          echo "â€¢ DockerMan: $ENABLE_DOCKERMAN"
          echo "â€¢ QModem Next: $ENABLE_QMODEM_NEXT"
          echo "â€¢ QModem: $ENABLE_QMODEM"
          echo "â€¢ MWAN: $ENABLE_MWAN"
          echo "â€¢ HomeProxy: $ENABLE_HOMEPROXY"
          echo "â€¢ Adbyby Plus: $ENABLE_ADBYBY_PLUS"
          echo "â€¢ åŽŸç‰ˆ Modem: $ENABLE_ORIGINAL_MODEM"
          echo "â€¢ NetSpeedTest: $ENABLE_NETSPEEDTEST"
          echo "â€¢ AT WebServer: $ENABLE_AT_WEBSERVER"
          echo "â€¢ ZeroTier: $ENABLE_ZEROTIER"
          echo "â€¢ WRtBWMon: $ENABLE_WRTBWMON"
          echo "â€¢ WatchCat: $ENABLE_WATCHCAT"
          echo "â€¢ EasyTier: $ENABLE_EASYTIER"
          echo "â€¢ Lucky: $ENABLE_LUCKY"
          echo "â€¢ Bandix: $ENABLE_BANDIX"
          echo "â€¢ Daed: $ENABLE_DAED"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: çŽ¯å¢ƒå‡†å¤‡å’Œç¼“å­˜è®¾ç½®
        run: |
          echo "ðŸ”§ å‡†å¤‡æž„å»ºçŽ¯å¢ƒ..."

          # åŸºç¡€æ¸…ç†
          sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
          docker system prune -f 2>/dev/null || true

          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "ðŸ’¾ å¯ç”¨ç£ç›˜ç©ºé—´: ${AVAIL_GB}GB"

          if [ "$AVAIL_GB" -lt 6 ]; then
            echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘6GB"
            exit 1
          fi

          # å®‰è£…å¿…è¦ä¾èµ–
          sudo apt-get update -qq
          sudo apt-get install -y build-essential git ccache python3 python3-pip \
            libncurses5-dev libssl-dev libgmp3-dev libmbedtls-dev rustc cargo \
            golang-go autoconf automake libtool patch make gcc g++ jq \
            clang llvm npm

          # è®¾ç½® ccache
          echo "ðŸ“¦ è®¾ç½® ccache..."
          export PATH="/usr/lib/ccache:$PATH"
          ccache --version || true

      - name: æ¢å¤æž„å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir
            ~/.ccache
          key: ${{ runner.os }}-build-${{ env.REPO_BRANCH }}-${{ hashFiles('feeds.conf.default', 'h5000m.extra.config') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.REPO_BRANCH }}-

      - name: æºç å’Œä¾èµ–å‡†å¤‡
        run: |
          # æ£€æŸ¥å¹¶å‡†å¤‡æºç 
          if [ ! -d "$SOURCE_DIR" ] || [ ! -d "$SOURCE_DIR/.git" ]; then
            echo "ðŸ“¥ å…‹éš†æºç ..."
            rm -rf "$SOURCE_DIR" 2>/dev/null || true
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
          else
            echo "ðŸ”„ æ£€æŸ¥æºç æ›´æ–°..."
            cd $SOURCE_DIR
            CURRENT_BRANCH=$(git branch --show-current)
            if [ "$CURRENT_BRANCH" != "$REPO_BRANCH" ]; then
              echo "åˆ†æ”¯ä¸åŒï¼Œé‡æ–°å…‹éš†..."
              cd ..
              rm -rf "$SOURCE_DIR"
              git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
            else
              git fetch origin $REPO_BRANCH
              LOCAL_COMMIT=$(git rev-parse HEAD)
              REMOTE_COMMIT=$(git rev-parse FETCH_HEAD)
              if [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
                echo "æœ‰æ›´æ–°ï¼Œé‡ç½®åˆ°æœ€æ–°..."
                git reset --hard FETCH_HEAD
              else
                echo "æºç å·²æ˜¯æœ€æ–°"
              fi
            fi
            cd ..
          fi

          # è®¾ç½® feeds
          cd $SOURCE_DIR
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
          fi

          # åŠ¨æ€ç®¡ç† feeds.conf.default (å¿…é¡»åœ¨æ¸…ç†å’Œæ›´æ–°ä¹‹å‰å®Œæˆ)
          # ä½¿ç”¨ jq æ£€æŸ¥ config/plugins.json æ¥å†³å®šæ˜¯å¦ä¿ç•™ Feed
          if [ "$(jq -r '.enable_nikki' config/plugins.json 2>/dev/null || echo 'false')" != "true" ]; then
            echo "ðŸ”§ ç¦ç”¨ nikki feed..."
            sed -i '/src-git nikki/d' feeds.conf.default
            sed -i '/nikki/d' feeds.conf.default
          fi

          # QModem feed
          if [ "$(jq -r '.enable_qmodem_next' config/plugins.json 2>/dev/null || echo 'false')" != "true" ] && [ "$(jq -r '.enable_qmodem' config/plugins.json 2>/dev/null || echo 'false')" != "true" ]; then
            echo "ðŸ”§ ç¦ç”¨ qmodem feed..."
            sed -i '/qmodem/d' feeds.conf.default
          fi

          # Adbyby Plus çŽ°åœ¨é€šè¿‡ç›´æŽ¥ clone ä»“åº“å®‰è£…ï¼Œä¸å†ä½¿ç”¨ feed

          # æ˜¾ç¤ºæœ€ç»ˆçš„ feeds.conf.default å†…å®¹
          echo "ðŸ“‹ å½“å‰ feeds.conf.default å†…å®¹:"
          cat feeds.conf.default

          # æ¸…ç† feeds ç¼“å­˜
          echo "ðŸ§¹ æ¸…ç† feeds ç¼“å­˜..."
          rm -rf tmp/.config* tmp/.packageinfo tmp/.targetinfo tmp/info tmp/.feeds* 2>/dev/null || true
          
          # æ¸…ç†ç¦ç”¨çš„ feeds
          [ "$(jq -r '.enable_nikki' config/plugins.json 2>/dev/null || echo 'false')" != "true" ] && rm -rf feeds/nikki* package/feeds/nikki 2>/dev/null || true
          [ "$(jq -r '.enable_qmodem_next' config/plugins.json 2>/dev/null || echo 'false')" != "true" ] && [ "$(jq -r '.enable_qmodem' config/plugins.json 2>/dev/null || echo 'false')" != "true" ] && rm -rf feeds/qmodem* package/feeds/qmodem 2>/dev/null || true

          # feeds update/install
          echo "ðŸ”„ æ›´æ–° feeds..."
          ./scripts/feeds update -a -j $(nproc) || true
          ./scripts/feeds install -a -f -j $(nproc) || true
          
          echo "âœ… feeds å¤„ç†å®Œæˆ"

      - name: å…‹éš†ç¬¬ä¸‰æ–¹ä»“åº“
        run: |
          cd $SOURCE_DIR
          echo "ðŸ“¥ å…‹éš†ç¬¬ä¸‰æ–¹ä»“åº“..."
          
          # NetSpeedTest
          if [ "$(jq -r '.enable_netspeedtest' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && [ ! -d "package/luci-app-netspeedtest" ]; then
            echo "ðŸ“¥ å…‹éš† netspeedtest ä»“åº“..."
            git clone https://github.com/sirpdboy/luci-app-netspeedtest.git -b master package/luci-app-netspeedtest
            if [ $? -ne 0 ]; then
              echo "âŒ netspeedtest ä»“åº“å…‹éš†å¤±è´¥"
              exit 1
            fi
          fi
          
          # AT WebServer
          if [ "$(jq -r '.enable_at_webserver' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && [ ! -d "package/luci-app-at-webserver" ]; then
            echo "ðŸ“¥ å…‹éš† at-webserver ä»“åº“..."
            git clone https://github.com/inotdream/mt5700webui-openwrt-server.git -b main package/luci-app-at-webserver
            if [ $? -ne 0 ]; then
              echo "âŒ at-webserver ä»“åº“å…‹éš†å¤±è´¥"
              exit 1
            fi
          fi
          
          # Lucky
          if [ "$(jq -r '.enable_lucky' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && [ ! -d "package/luci-app-lucky" ]; then
            echo "ðŸ“¥ å…‹éš† lucky ä»“åº“..."
            git clone https://github.com/gdy666/luci-app-lucky.git -b main package/luci-app-lucky
            if [ $? -ne 0 ]; then
              echo "âŒ lucky ä»“åº“å…‹éš†å¤±è´¥"
              exit 1
            fi
          fi
          
          # Daed
          if [ "$(jq -r '.enable_daed' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && [ ! -d "package/dae" ]; then
            echo "ðŸ“¥ å…‹éš† daed ä»“åº“..."
            git clone https://github.com/QiuSimons/luci-app-daed.git package/dae
            if [ $? -ne 0 ]; then
              echo "âŒ daed ä»“åº“å…‹éš†å¤±è´¥"
              exit 1
            fi
            # å®‰è£… pnpm (ç¼–è¯‘å‰ç«¯ç•Œé¢éœ€è¦)
            sudo npm install -g pnpm
          fi

      - name: ä¸‹è½½ Release è½¯ä»¶åŒ…å¹¶å‡†å¤‡è‡ªåŠ¨å®‰è£…
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd $SOURCE_DIR
          # æ ‡å‡†åŒ– files ç›®å½•ç»“æž„
          INSTALL_DIR="files/root/ipks"
          mkdir -p $INSTALL_DIR
          mkdir -p files/etc/uci-defaults
          mkdir -p files/etc/config
          mkdir -p files/etc/init.d
          mkdir -p files/usr/bin
          mkdir -p files/usr/lib
          
          echo "âœ… files ç›®å½•ç»“æž„æ ‡å‡†åŒ–å®Œæˆ"

          # --- ä¸‹è½½ EasyTier ---
          if [ "$(jq -r '.enable_easytier' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
            echo "ðŸ“¥ èŽ·å– EasyTier Release URL..."
            # ä½¿ç”¨ jq è¿›è¡Œç¨³å¥çš„ JSON è§£æž
            # åªé€‰æ‹©åŒ…å« aarch64_cortex-a53 å’Œ 22.03.7 çš„éž SNAPSHOT ç‰ˆæœ¬
            ET_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/EasyTier/luci-app-easytier/releases/latest | jq -r '.assets[] | select(.name | contains("aarch64_cortex-a53") and contains("22.03.7") and (contains("SNAPSHOT") | not)).browser_download_url // empty' | head -1)
            # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„ç‰ˆæœ¬ï¼Œåˆ™ä½¿ç”¨åŒ…å« aarch64_cortex-a53 çš„ç‰ˆæœ¬
            if [ -z "$ET_URL" ] || [ "$ET_URL" = "null" ] || [ "$ET_URL" = "" ]; then
              ET_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/EasyTier/luci-app-easytier/releases/latest | jq -r '.assets[] | select(.name | contains("aarch64_cortex-a53") and (contains("SNAPSHOT") | not)).browser_download_url // empty' | head -1)
            fi
            if [ -n "$ET_URL" ] && [ "$ET_URL" != "null" ] && [ "$ET_URL" != "" ]; then
              echo "æ­£åœ¨ä¸‹è½½: $ET_URL"
              wget -qO /tmp/easytier.zip "$ET_URL"
              # æ£€æŸ¥ä¸‹è½½ç»“æžœ
              if [ -f "/tmp/easytier.zip" ] && [ "$(stat -c %s "/tmp/easytier.zip")" -gt 1024 ]; then
                unzip -o /tmp/easytier.zip -d $INSTALL_DIR/
                # æ£€æŸ¥è§£åŽ‹ç»“æžœ
                IPK_FILES=$(ls -la "$INSTALL_DIR"/easytier*.ipk 2>/dev/null | wc -l)
                if [ "$IPK_FILES" -gt 0 ]; then
                  echo "âœ… EasyTier ä¸‹è½½å¹¶è§£åŽ‹æˆåŠŸ"
                else
                  echo "âŒ EasyTier è§£åŽ‹å¤±è´¥"
                  exit 1
                fi
              else
                echo "âŒ EasyTier ä¸‹è½½å¤±è´¥"
                exit 1
              fi
            else
              echo "âŒ æ— æ³•èŽ·å– EasyTier ä¸‹è½½åœ°å€ï¼Œè¯·æ£€æŸ¥ä»“åº“ Release åç§°"
              exit 1
            fi
          fi

          # --- ä¸‹è½½ Bandix ---
          if [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
            echo "ðŸ“¥ èŽ·å– Bandix Release URL..."
            # ä½¿ç”¨ jq è¿›è¡Œç¨³å¥çš„ JSON è§£æž
            # æ ¸å¿ƒåŒ…ï¼šåŒ¹é…åŒ…å« bandix å’Œ aarch64_cortex-a53 çš„ .ipk æ–‡ä»¶
            BD_CORE_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/timsaya/openwrt-bandix/releases/latest | jq -r '.assets[] | select(.name | contains("bandix") and contains("aarch64_cortex-a53") and contains(".ipk")).browser_download_url // empty' | head -1)
            # å‰ç«¯åŒ…ï¼šåŒ¹é…åŒ…å« luci-app-bandix çš„ .ipk æ–‡ä»¶
            BD_LUCI_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/timsaya/luci-app-bandix/releases/latest | jq -r '.assets[] | select(.name | contains("luci-app-bandix") and contains(".ipk")).browser_download_url // empty' | head -1)
            # è¯­è¨€åŒ…ï¼šåŒ¹é…åŒ…å« luci-i18n-bandix-zh-cn çš„ .ipk æ–‡ä»¶
            BD_I18N_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/timsaya/luci-app-bandix/releases/latest | jq -r '.assets[] | select(.name | contains("luci-i18n-bandix-zh-cn") and contains(".ipk")).browser_download_url // empty' | head -1)
            # åˆå¹¶æ‰€æœ‰ Bandix URL
            BD_LUCI_URLS=""
            [ -n "$BD_LUCI_URL" ] && BD_LUCI_URLS="$BD_LUCI_URLS $BD_LUCI_URL"
            [ -n "$BD_I18N_URL" ] && BD_LUCI_URLS="$BD_LUCI_URLS $BD_I18N_URL"
            
            if [ -n "$BD_CORE_URL" ] && [ "$BD_CORE_URL" != "null" ] && [ "$BD_CORE_URL" != "" ]; then
              echo "æ­£åœ¨ä¸‹è½½ Bandix æ ¸å¿ƒ: $BD_CORE_URL"
              wget -P $INSTALL_DIR/ "$BD_CORE_URL"
              # æ£€æŸ¥ä¸‹è½½ç»“æžœ
              CORE_FILE=$(basename "$BD_CORE_URL")
              if [ -f "$INSTALL_DIR/$CORE_FILE" ] && [ "$(stat -c %s "$INSTALL_DIR/$CORE_FILE")" -gt 1024 ]; then
                echo "âœ… Bandix æ ¸å¿ƒä¸‹è½½æˆåŠŸ"
              else
                echo "âŒ Bandix æ ¸å¿ƒä¸‹è½½å¤±è´¥"
                exit 1
              fi
              
              # ä¸‹è½½ LuCI ç•Œé¢å’Œè¯­è¨€åŒ…
              if [ -n "$BD_LUCI_URLS" ] && [ "$BD_LUCI_URLS" != "" ]; then
                echo "æ­£åœ¨ä¸‹è½½ Bandix LuCI åŒ…..."
                echo "$BD_LUCI_URLS" | xargs -n 1 wget -P $INSTALL_DIR/
                # æ£€æŸ¥ä¸‹è½½ç»“æžœ
                LUCI_FILES=$(ls -la "$INSTALL_DIR"/luci-app-bandix*.ipk 2>/dev/null | wc -l)
                if [ "$LUCI_FILES" -gt 0 ]; then
                  echo "âœ… Bandix LuCI åŒ…ä¸‹è½½æˆåŠŸ"
                else
                  echo "âŒ Bandix LuCI åŒ…ä¸‹è½½å¤±è´¥"
                  exit 1
                fi
              else
                echo "âš ï¸  æ— æ³•èŽ·å– Bandix LuCI åŒ…åœ°å€ï¼Œè·³è¿‡ä¸‹è½½"
              fi
            else
              echo "âŒ æ— æ³•èŽ·å– Bandix ä¸‹è½½åœ°å€ï¼Œå¯èƒ½æ˜¯ GitHub API é™åˆ¶æˆ–ä»“åº“æ— å‘å¸ƒç‰ˆæœ¬"
              exit 1
            fi
          fi

          # --- åˆ›å»ºè‡ªåŠ¨å®‰è£…è„šæœ¬ ---
          cat > files/etc/uci-defaults/99-install-custom-ipks << 'EOF'
          #!/bin/sh
          if [ -d "/root/ipks" ]; then
            # ä¼˜å…ˆå®‰è£…æ ¸å¿ƒä¾èµ–ï¼Œå†å®‰è£…ç•Œé¢
            opkg install /root/ipks/easytier*.ipk
            opkg install /root/ipks/bandix*.ipk
            opkg install /root/ipks/luci-app-*.ipk
            opkg install /root/ipks/luci-i18n-*.ipk
            rm -rf /root/ipks
          fi
          exit 0
          EOF
          chmod +x files/etc/uci-defaults/99-install-custom-ipks

      - name: æ’ä»¶é…ç½®å…³è”
        run: |
          cd $SOURCE_DIR
          touch features.config
          
          # é€»è¾‘ç»Ÿä¸€ï¼šå¼€å¯æ’ä»¶æ—¶ï¼Œå¼ºåˆ¶å…³è”å¼€å¯ä¾èµ–
          if [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
              echo "CONFIG_PACKAGE_zoneinfo-all=y" >> features.config
              echo "CONFIG_PACKAGE_zoneinfo-core=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-tun=y" >> features.config
              echo "CONFIG_PACKAGE_libstdcpp=y" >> features.config
              echo "CONFIG_PACKAGE_libpthread=y" >> features.config
              echo "CONFIG_PACKAGE_librt=y" >> features.config
          fi
          
          if [ "$(jq -r '.enable_easytier' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
              echo "CONFIG_PACKAGE_kmod-tun=y" >> features.config
              echo "CONFIG_PACKAGE_libstdcpp=y" >> features.config
              echo "CONFIG_PACKAGE_libpthread=y" >> features.config
              echo "CONFIG_PACKAGE_librt=y" >> features.config
          fi
          
          if [ "$(jq -r '.enable_daed' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
              # è½¯ä»¶åŒ…é…ç½®
              echo "CONFIG_PACKAGE_luci-app-daed=y" >> features.config
              echo "CONFIG_PACKAGE_luci-i18n-daed-zh-cn=y" >> features.config
              # å†…æ ¸ eBPF æ”¯æŒé…ç½®
              echo "CONFIG_DEVEL=y" >> features.config
              echo "CONFIG_KERNEL_DEBUG_INFO=y" >> features.config
              echo "CONFIG_KERNEL_DEBUG_INFO_REDUCED=n" >> features.config
              echo "CONFIG_KERNEL_DEBUG_INFO_BTF=y" >> features.config
              echo "CONFIG_KERNEL_CGROUPS=y" >> features.config
              echo "CONFIG_KERNEL_CGROUP_BPF=y" >> features.config
              echo "CONFIG_KERNEL_BPF_EVENTS=y" >> features.config
              echo "CONFIG_BPF_TOOLCHAIN_HOST=y" >> features.config
              echo "CONFIG_KERNEL_XDP_SOCKETS=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-xdp-sockets-diag=y" >> features.config
          fi
          
          if [ "$(jq -r '.enable_nikki' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
              echo "CONFIG_PACKAGE_nikki=y" >> features.config
              echo "CONFIG_PACKAGE_luci-app-nikki=y" >> features.config
              echo "CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y" >> features.config
              echo "CONFIG_PACKAGE_ca-bundle=y" >> features.config
              echo "CONFIG_PACKAGE_curl=y" >> features.config
              echo "CONFIG_PACKAGE_yq=y" >> features.config
              echo "CONFIG_PACKAGE_firewall4=y" >> features.config
              echo "CONFIG_PACKAGE_ip-full=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-inet-diag=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-nft-socket=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-nft-tproxy=y" >> features.config
              echo "CONFIG_PACKAGE_kmod-tun=y" >> features.config
          fi
          
          echo "âœ… æ’ä»¶é…ç½®å…³è”å®Œæˆ"
          cat features.config

      - name: ä¿®å¤ä¾èµ–å’Œè¡¥ä¸
        run: |
          cd $SOURCE_DIR
          echo "ðŸ”§ åº”ç”¨è¡¥ä¸å’Œä¿®å¤ä¾èµ–..."
          
          # â­ ä¿®å¤ ebtables ä¸‹è½½é—®é¢˜ (é•œåƒç«™æ–‡ä»¶å“ˆå¸Œä¸åŒ¹é…)
          EBTABLES_MAKEFILE="package/network/utils/ebtables/Makefile"
          if [ -f "$EBTABLES_MAKEFILE" ]; then
            echo "ðŸ”§ ä¿®å¤ ebtables ä¸‹è½½æºå’Œå“ˆå¸Œ..."
            # ä½¿ç”¨ netfilter å®˜æ–¹ GitHub é•œåƒ
            sed -i 's|https://git.netfilter.org/ebtables|https://github.com/netfilter/ebtables.git|g' "$EBTABLES_MAKEFILE"
            sed -i 's|git://git.netfilter.org/ebtables|https://github.com/netfilter/ebtables.git|g' "$EBTABLES_MAKEFILE"
            # æ›´æ–°å“ˆå¸Œå€¼ä¸ºé•œåƒç«™å®žé™…æä¾›çš„æ–‡ä»¶å“ˆå¸Œ (è§£å†³å“ˆå¸Œä¸åŒ¹é…é—®é¢˜)
            sed -i 's|PKG_MIRROR_HASH:=.*|PKG_MIRROR_HASH:=skip|g' "$EBTABLES_MAKEFILE"
            echo "âœ… ebtables ä¸‹è½½æºå·²ä¿®å¤"
          fi
          
          # â­ ä¿®å¤ QMI WWAN é©±åŠ¨ Linux 6.6 å…¼å®¹æ€§ (æ‰€æœ‰åŽ‚å•†é©±åŠ¨)
          fix_qmi_driver() {
            local SOURCE_FILE="$1"
            if [ -f "$SOURCE_FILE" ]; then
              echo "ðŸ”§ ä¿®å¤é©±åŠ¨: $SOURCE_FILE"
              
              # ä¿®å¤ u64_stats API å˜æ›´ (Linux 6.x ç§»é™¤äº† _irq åŽç¼€)
              sed -i 's/u64_stats_fetch_begin_irq/u64_stats_fetch_begin/g' "$SOURCE_FILE"
              sed -i 's/u64_stats_fetch_retry_irq/u64_stats_fetch_retry/g' "$SOURCE_FILE"
              
              # ä¿®å¤ dev_addr åªè¯»é—®é¢˜ (Linux 5.15+ dev_addr å˜ä¸º const)
              # æ–¹æ³•1: ä½¿ç”¨ eth_hw_addr_set (æŽ¨è)
              if grep -q 'memcpy.*qmap_net->dev_addr.*real_dev->dev_addr' "$SOURCE_FILE"; then
                sed -i 's/memcpy[[:space:]]*(qmap_net->dev_addr,[[:space:]]*real_dev->dev_addr,[[:space:]]*ETH_ALEN);/eth_hw_addr_set(qmap_net, real_dev->dev_addr);/g' "$SOURCE_FILE"
              fi
              # æ–¹æ³•2: å¤„ç†å…¶ä»–å¯èƒ½çš„ memcpy åˆ° dev_addr çš„æƒ…å†µ
              if grep -q 'memcpy.*->dev_addr' "$SOURCE_FILE"; then
                # ä½¿ç”¨ dev_addr_set ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                sed -i 's/memcpy[[:space:]]*(\([^,]*\)->dev_addr,[[:space:]]*\([^,]*\),[[:space:]]*ETH_ALEN);/dev_addr_set(\1, \2);/g' "$SOURCE_FILE" 2>/dev/null || true
              fi
              
              echo "âœ… é©±åŠ¨ä¿®å¤å®Œæˆ: $SOURCE_FILE"
            fi
          }
          
          # ä¿®å¤ Fibocom QMI WWAN é©±åŠ¨
          fix_qmi_driver "package/mtk/applications/5g-modem/fibocom_QMI_WWAN/qmi_wwan_f.c"
          fix_qmi_driver "package/mtk/applications/5g-modem/fibocom_QMI_WWAN/src/qmi_wwan_f.c"
          
          # ä¿®å¤ Quectel QMI WWAN é©±åŠ¨ (å¦‚æžœå­˜åœ¨)
          fix_qmi_driver "package/mtk/applications/5g-modem/quectel_QMI_WWAN/qmi_wwan_q.c"
          fix_qmi_driver "package/mtk/applications/5g-modem/quectel_QMI_WWAN/src/qmi_wwan_q.c"
          
          # ä¿®å¤ Simcom QMI WWAN é©±åŠ¨ (å¦‚æžœå­˜åœ¨)
          fix_qmi_driver "package/mtk/applications/5g-modem/simcom_QMI_WWAN/qmi_wwan_s.c"
          fix_qmi_driver "package/mtk/applications/5g-modem/simcom_QMI_WWAN/src/qmi_wwan_s.c"
          
          # ä¿®å¤ feeds ä¸­çš„ QModem é©±åŠ¨ (å¦‚æžœå­˜åœ¨ä¸”å·²å¯ç”¨)
          if [ -d "feeds/qmodem" ]; then
            for driver_file in $(find feeds/qmodem -name "*.c" -type f 2>/dev/null | xargs grep -l "u64_stats_fetch_begin_irq\|memcpy.*dev_addr" 2>/dev/null || true); do
              fix_qmi_driver "$driver_file"
            done
          fi
          
          # ä¸‹è½½é¢å¤–åŒ…
          if [ "$(jq -r '.enable_adguardhome' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
            [ ! -d "package/luci-app-adguardhome" ] && \
              git clone --depth=1 https://github.com/kongfl888/luci-app-adguardhome.git package/luci-app-adguardhome
            
            AGH_LUCI_SCRIPT="package/luci-app-adguardhome/root/usr/share/AdGuardHome/links.sh"
            if [ -f "$AGH_LUCI_SCRIPT" ]; then
              sed -i 's|mv /usr/bin/AdGuardHome/AdGuardHome|rm -rf /usr/bin/AdGuardHome 2>/dev/null; mkdir -p /usr/bin/AdGuardHome; mv /tmp/AdGuardHomeupdate/AdGuardHome_linux_*/AdGuardHome|g' "$AGH_LUCI_SCRIPT" || true
            fi
            
            AGH_LUCI_INIT="package/luci-app-adguardhome/root/etc/init.d/AdGuardHome"
            if [ -f "$AGH_LUCI_INIT" ]; then
              sed -i '/^#!/a\
            [ -f /usr/bin/AdGuardHome ] && rm -f /usr/bin/AdGuardHome && mkdir -p /usr/bin/AdGuardHome' "$AGH_LUCI_INIT" || true
            fi
          fi

          # Adbyby Plus Lite å®‰è£… (ä»“åº“ç»“æž„: luci-app-adbyby-plus å­ç›®å½•)
          if [ "$(jq -r '.enable_adbyby_plus' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
            echo "ðŸ”§ å®‰è£… Adbyby Plus Lite..."
            if [ ! -d "package/luci-app-adbyby-plus" ]; then
              git clone --depth=1 --recurse-submodules https://github.com/kongfl888/luci-app-adbyby-plus-lite.git /tmp/adbyby-plus-lite
              cp -r /tmp/adbyby-plus-lite/luci-app-adbyby-plus package/luci-app-adbyby-plus
              rm -rf /tmp/adbyby-plus-lite
            fi
            # ç¡®ä¿ä¾èµ–åŒ…å­˜åœ¨ (ipset ç”¨äºŽ Plus+ æ¨¡å¼)
            echo "CONFIG_PACKAGE_ipset=y" >> .config 2>/dev/null || true
            echo "âœ… Adbyby Plus Lite å®‰è£…å®Œæˆ"
          fi

          # MosDNS å®‰è£…æ­¥éª¤
          if [ "$(jq -r '.enable_mosdns' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
            if [ ! -d "feeds/packages/lang/golang" ] || [ ! -f "feeds/packages/lang/golang/Makefile" ]; then
              rm -rf feeds/packages/lang/golang
              git clone https://github.com/sbwml/packages_lang_golang -b 24.x feeds/packages/lang/golang
            fi
            rm -rf feeds/packages/net/v2ray-geodata
            if [ ! -d "package/mosdns" ]; then
              git clone https://github.com/sbwml/luci-app-mosdns -b v5 package/mosdns
            fi
            if [ ! -d "package/v2ray-geodata" ]; then
              git clone https://github.com/sbwml/v2ray-geodata package/v2ray-geodata
            fi
            # æ·»åŠ æ±‰åŒ–åŒ…
            echo "CONFIG_PACKAGE_luci-i18n-mosdns-zh-cn=y" >> .config
          fi
          
          rm -rf package/feeds/packages/{exim,onionshare-cli,python-zope-event,python-zope-interface,python-gevent,python-twisted} 2>/dev/null || true

          # QModem ç›¸å…³ä¿®å¤
          if [ -d "package/feeds/qmodem" ]; then
            rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true
            # ç§»é™¤ kmod-mhi-wwan ä¾èµ–
            find . -path "*qmodem*Makefile" -exec sed -i 's/+\?kmod-mhi-wwan//g' {} \; 2>/dev/null || true
          fi

          # ä¿®å¤ mt_hwifi
          [ -f "package/mtk/drivers/mt_hwifi/Makefile" ] && sed -i 's/+kmod-mt_wifi_osal//g' "package/mtk/drivers/mt_hwifi/Makefile" || true

          # é¢„è£… Clash å†…æ ¸
          echo "ðŸ”§ é¢„è£… Clash å†…æ ¸..."
          # æ£€æŸ¥æ˜¯å¦å¯ç”¨äº† OpenClash
          if [ "$(jq -r '.enable_openclash' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
            echo "ðŸ“¦ å®‰è£… OpenClash ä¾èµ–..."
            # ç¡®ä¿ OpenClash ç›®å½•å­˜åœ¨
            mkdir -p feeds/luci/applications/luci-app-openclash/root/etc/openclash/core
            core_path="feeds/luci/applications/luci-app-openclash/root/etc/openclash/core"
            goe_path="feeds/luci/applications/luci-app-openclash/root/etc/openclash"
            
            # ä¸‹è½½ Clash Meta å†…æ ¸
            CLASH_META_URL="https://raw.githubusercontent.com/vernesong/OpenClash/core/master/meta/clash-linux-arm64.tar.gz"
            GEOIP_URL="https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat"
            GEOSITE_URL="https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat"
            
            echo "ðŸ“¥ ä¸‹è½½ Clash Meta å†…æ ¸..."
            wget -qO- $CLASH_META_URL | tar xOvz > $core_path/clash_meta
            echo "ðŸ“¥ ä¸‹è½½ GeoIP æ•°æ®..."
            wget -qO- $GEOIP_URL > $goe_path/GeoIP.dat
            echo "ðŸ“¥ ä¸‹è½½ GeoSite æ•°æ®..."
            wget -qO- $GEOSITE_URL > $goe_path/GeoSite.dat
            
            # è®¾ç½®æƒé™
            chmod +x $core_path/clash_meta
            echo "âœ… Clash å†…æ ¸é¢„è£…å®Œæˆ"
            ls -la $core_path/
          else
            echo "âš ï¸ æœªå¯ç”¨ OpenClashï¼Œè·³è¿‡ Clash å†…æ ¸é¢„è£…"
          fi

      - name: ä¿®æ”¹é»˜è®¤LAN IPåœ°å€
        run: |
          cd $SOURCE_DIR
          echo "ðŸ”§ ä¿®æ”¹é»˜è®¤LAN IPåœ°å€ä¸º 192.168.88.1..."
          
          # ä½¿ç”¨config_generateè„šæœ¬æ–¹æ³•ï¼ˆæœ€å¯é ï¼‰
          sed -i 's/192.168.6.1/192.168.88.1/g' package/base-files/files/bin/config_generate
          echo "âœ… é…ç½®ç”Ÿæˆè„šæœ¬å·²ä¿®æ”¹ï¼Œé»˜è®¤LAN IPåœ°å€å·²è®¾ç½®ä¸º 192.168.88.1"
          cat package/base-files/files/bin/config_generate | grep -E "192\.168\.88\.1" || true

      - name: é…ç½®æž„å»º
        run: |
          cd $SOURCE_DIR
          echo "âš™ï¸ é…ç½®æž„å»ºé€‰é¡¹..."

          # éªŒè¯äº’æ–¥é€‰é¡¹
          if [ "${{ steps.set-env.outputs.enable_qmodem_next }}" = "true" ] && [ "${{ steps.set-env.outputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨ QModem Next å’Œ QModemï¼"
            exit 1
          fi
          if [ "${{ steps.set-env.outputs.enable_original_modem }}" = "true" ] && [ "${{ steps.set-env.outputs.enable_qmodem_next }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨åŽŸç‰ˆ Modem å’Œ QModem Nextï¼"
            exit 1
          fi
          if [ "${{ steps.set-env.outputs.enable_original_modem }}" = "true" ] && [ "${{ steps.set-env.outputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨åŽŸç‰ˆ Modem å’Œ QModemï¼"
            exit 1
          fi

          # ä¸‹è½½åŸºç¡€é…ç½®
          curl -fsSL "$CONFIG_URL" -o base.config || {
            [ -f "defconfig/mt7987_mt7992.config" ] && cp defconfig/mt7987_mt7992.config base.config
          }

          cat base.config > .config

          # ä¾èµ–é¢„è£…è‡ªåŠ¨åŒ–
          echo "ðŸ”§ ä¾èµ–é¢„è£…è‡ªåŠ¨åŒ–..."
          
          # å»ºç«‹ä¾èµ–æ˜ å°„è¡¨
          [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_zoneinfo-all=y" >> .config
          [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_zoneinfo-core=y" >> .config
          [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
          [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_libstdcpp=y" >> .config
          [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_libpthread=y" >> .config
          [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_librt=y" >> .config
          [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_curl=y" >> .config
          [ "$(jq -r '.enable_bandix' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_libopenssl=y" >> .config
          
          [ "$(jq -r '.enable_easytier' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
          [ "$(jq -r '.enable_easytier' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_libstdcpp=y" >> .config
          [ "$(jq -r '.enable_easytier' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_libpthread=y" >> .config
          [ "$(jq -r '.enable_easytier' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_librt=y" >> .config
          [ "$(jq -r '.enable_easytier' config/plugins.json 2>/dev/null || echo 'false')" = "true" ] && echo "CONFIG_PACKAGE_libopenssl=y" >> .config
          
          echo "âœ… ä¾èµ–é¢„è£…è‡ªåŠ¨åŒ–å®Œæˆ"

          # åº”ç”¨é¢å¤–é…ç½®
          if [ -f "$GITHUB_WORKSPACE/h5000m.extra.config" ]; then
            echo "ðŸ“„ åº”ç”¨é¢å¤–é…ç½®..."
            cat "$GITHUB_WORKSPACE/h5000m.extra.config" >> .config
          fi

          # åº”ç”¨æ’ä»¶é…ç½®å…³è”
          if [ -f "features.config" ]; then
            echo "ðŸ“„ åº”ç”¨æ’ä»¶é…ç½®å…³è”..."
            cat features.config >> .config
          fi

          # IPåœ°å€ä¿®æ”¹å·²åœ¨å‰é¢çš„æ­¥éª¤ä¸­å®Œæˆï¼ˆä½¿ç”¨config_generateè„šæœ¬æ–¹æ³•ï¼‰

          # ç¡¬ç¼–ç æŒ‡å®šæ’ä»¶å·²ç§»è‡³ h5000m.extra.config æ–‡ä»¶

          # æ ¹æ®è¾“å…¥åŠ¨æ€é…ç½®åŒ…ï¼ˆç®€åŒ–ï¼šåªå¯ç”¨é¡¶å±‚åŒ…ï¼Œä¾èµ–ç”± make defconfig è‡ªåŠ¨è§£æžï¼‰
          disabled_pkgs=("luci-app-sms-tool-lite" "luci-app-3ginfo-lite")

          # è¯»å–çŽ¯å¢ƒå˜é‡åˆ°å…³è”æ•°ç»„
          declare -A pkg_enabled
          pkg_enabled["adguardhome"]="${{ steps.set-env.outputs.enable_adguardhome }}"
          pkg_enabled["openclash"]="${{ steps.set-env.outputs.enable_openclash }}"
          pkg_enabled["nikki"]="${{ steps.set-env.outputs.enable_nikki }}"
          pkg_enabled["upnp"]="${{ steps.set-env.outputs.enable_upnp }}"
          pkg_enabled["vlmcsd"]="${{ steps.set-env.outputs.enable_vlmcsd }}"
          pkg_enabled["mosdns"]="${{ steps.set-env.outputs.enable_mosdns }}"
          pkg_enabled["dockerman"]="${{ steps.set-env.outputs.enable_dockerman }}"
          pkg_enabled["mwan3"]="${{ steps.set-env.outputs.enable_mwan }}"
          pkg_enabled["homeproxy"]="${{ steps.set-env.outputs.enable_homeproxy }}"
          pkg_enabled["adbyby-plus"]="${{ steps.set-env.outputs.enable_adbyby_plus }}"
          pkg_enabled["netspeedtest"]="${{ steps.set-env.outputs.enable_netspeedtest }}"
          pkg_enabled["at-webserver"]="${{ steps.set-env.outputs.enable_at_webserver }}"
          pkg_enabled["zerotier"]="${{ steps.set-env.outputs.enable_zerotier }}"
          pkg_enabled["wrtbwmon"]="${{ steps.set-env.outputs.enable_wrtbwmon }}"
          pkg_enabled["watchcat"]="${{ steps.set-env.outputs.enable_watchcat }}"
          pkg_enabled["easytier"]="${{ steps.set-env.outputs.enable_easytier }}"
          pkg_enabled["lucky"]="${{ steps.set-env.outputs.enable_lucky }}"
          pkg_enabled["bandix"]="${{ steps.set-env.outputs.enable_bandix }}"
          # æ³¨æ„ï¼šEasyTier å’Œ Bandix éƒ½é€šè¿‡ç¦»çº¿åŒ…æ–¹å¼å®‰è£…ï¼Œä¸åœ¨ .config æ–‡ä»¶ä¸­æ·»åŠ é…ç½®

          for pkg in "${!pkg_enabled[@]}"; do
            if [ "${pkg_enabled[$pkg]}" = "true" ]; then
              # nikki éœ€è¦ç‰¹æ®Šå¤„ç†
              if [ "$pkg" = "nikki" ]; then
                echo "ðŸ”§ é…ç½® Nikki åŠå…¶ä¾èµ–..."
                # Nikki æ ¸å¿ƒåŒ…
                echo "CONFIG_PACKAGE_nikki=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-nikki=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y" >> .config
                # Nikki ä¾èµ–
                echo "CONFIG_PACKAGE_ca-bundle=y" >> .config
                echo "CONFIG_PACKAGE_curl=y" >> .config
                echo "CONFIG_PACKAGE_yq=y" >> .config
                echo "CONFIG_PACKAGE_firewall4=y" >> .config
                echo "CONFIG_PACKAGE_ip-full=y" >> .config
                echo "CONFIG_PACKAGE_kmod-inet-diag=y" >> .config
                echo "CONFIG_PACKAGE_kmod-nft-socket=y" >> .config
                echo "CONFIG_PACKAGE_kmod-nft-tproxy=y" >> .config
                echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
              elif [ "$pkg" = "easytier" ] || [ "$pkg" = "bandix" ]; then
                echo "ðŸ”§ $pkg å·²åœ¨å‰é¢çš„æ­¥éª¤ä¸­é€šè¿‡ç¦»çº¿åŒ…æ–¹å¼å¤„ç†ï¼Œè·³è¿‡é…ç½®..."
              elif [ "$pkg" = "openclash" ]; then
                echo "ðŸ”§ é…ç½® openclash..."
                echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
                # é¢„ç½® Clash å†…æ ¸
                echo -e "é¢„ç½® Clash å†…æ ¸"
                mkdir -p feeds/luci/applications/luci-app-openclash/root/etc/openclash/core
                core_path="feeds/luci/applications/luci-app-openclash/root/etc/openclash/core"
                goe_path="feeds/luci/applications/luci-app-openclash/root/etc/openclash"
                CLASH_META_URL="https://raw.githubusercontent.com/vernesong/OpenClash/core/master/meta/clash-linux-arm64.tar.gz"
                GEOIP_URL="https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat"
                GEOSITE_URL="https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat"
                # ä¸‹è½½å¹¶å®‰è£…å†…æ ¸
                wget -qO- $CLASH_META_URL | tar xOvz > $core_path/clash_meta
                wget -qO- $GEOIP_URL > $goe_path/GeoIP.dat
                wget -qO- $GEOSITE_URL > $goe_path/GeoSite.dat
                # è®¾ç½®æƒé™
                chmod +x $core_path/clash*
              elif [ "$pkg" = "adguardhome" ]; then
                echo "CONFIG_PACKAGE_luci-app-$pkg=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-$pkg-zh-cn=y" >> .config
              elif [ "$pkg" = "adbyby-plus" ]; then
                # adbyby-plus åŠå…¶ä¾èµ– (Plus+ æ¨¡å¼éœ€è¦ ipset)
                echo "CONFIG_PACKAGE_luci-app-adbyby-plus=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-adbyby-plus-zh-cn=y" >> .config
                echo "CONFIG_PACKAGE_ipset=y" >> .config
              elif [ "$pkg" = "netspeedtest" ]; then
                echo "ðŸ”§ é…ç½® netspeedtest..."
                echo "CONFIG_PACKAGE_luci-app-netspeedtest=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-netspeedtest-zh-cn=y" >> .config
              elif [ "$pkg" = "at-webserver" ]; then
                echo "ðŸ”§ é…ç½® at-webserver..."
                echo "CONFIG_PACKAGE_luci-app-at-webserver=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-at-webserver-zh-cn=y" >> .config
              elif [ "$pkg" = "zerotier" ]; then
                echo "CONFIG_PACKAGE_zerotier=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-zerotier-zh-cn=y" >> .config
              elif [ "$pkg" = "wrtbwmon" ]; then
                echo "CONFIG_PACKAGE_wrtbwmon=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-wrtbwmon=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-wrtbwmon-zh-cn=y" >> .config
              elif [ "$pkg" = "watchcat" ]; then
                echo "CONFIG_PACKAGE_watchcat=y" >> .config
                echo "CONFIG_PACKAGE_luci-app-watchcat=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-watchcat-zh-cn=y" >> .config
              elif [ "$pkg" = "lucky" ]; then
                echo "ðŸ”§ é…ç½® lucky..."
                echo "CONFIG_PACKAGE_luci-app-lucky=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-lucky-zh-cn=y" >> .config
              else
                echo "CONFIG_PACKAGE_luci-app-$pkg=y" >> .config
              fi
            else
              # ç‰¹æ®ŠåŒ…ç¦ç”¨æ—¶æ·»åŠ æ‰€æœ‰ç›¸å…³åŒ…
              if [ "$pkg" = "nikki" ]; then
                disabled_pkgs+=('nikki' 'luci-app-nikki' 'luci-i18n-nikki-zh-cn' 'luci-i18n-nikki-en')
              elif [ "$pkg" = "adbyby-plus" ]; then
                disabled_pkgs+=('luci-app-$pkg' 'luci-i18n-$pkg-zh-cn')
              elif [ "$pkg" = "netspeedtest" ]; then
                disabled_pkgs+=('luci-app-netspeedtest')
              elif [ "$pkg" = "at-webserver" ]; then
                disabled_pkgs+=('luci-app-at-webserver')
              elif [ "$pkg" = "zerotier" ]; then
                disabled_pkgs+=('zerotier' 'luci-app-zerotier')
              elif [ "$pkg" = "wrtbwmon" ]; then
                disabled_pkgs+=('wrtbwmon' 'luci-app-wrtbwmon')
              elif [ "$pkg" = "watchcat" ]; then
                disabled_pkgs+=('watchcat' 'luci-app-watchcat')
              elif [ "$pkg" = "easytier" ]; then
                echo "ðŸ”§ è·³è¿‡ç¦ç”¨ $pkgï¼Œå› ä¸ºå®ƒé€šè¿‡ç¦»çº¿åŒ…æ–¹å¼å®‰è£…"
              elif [ "$pkg" = "bandix" ]; then
                echo "ðŸ”§ è·³è¿‡ç¦ç”¨ $pkgï¼Œå› ä¸ºå®ƒé€šè¿‡ç¦»çº¿åŒ…æ–¹å¼å®‰è£…"
              elif [ "$pkg" = "lucky" ]; then
                disabled_pkgs+=('luci-app-lucky')
              else
                disabled_pkgs+=('luci-app-$pkg')
              fi
            fi
          done

          # åŽŸç‰ˆ Modem å¤„ç†ï¼ˆäº’æ–¥ï¼‰
          if [ "$(jq -r '.enable_original_modem' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-modem=y" >> .config
            echo "CONFIG_PACKAGE_modem=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-modem-zh-cn=y" >> .config
          else
            disabled_pkgs+=("luci-app-modem" "modem" "luci-i18n-modem-zh-cn" "luci-i18n-modem-en")
          fi

          # QModem ç‰¹æ®Šå¤„ç†ï¼ˆäº’æ–¥ï¼‰
          if [ "$(jq -r '.enable_qmodem_next' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-qmodem-next=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-qmodem-next-zh-cn=y" >> .config
          elif [ "$(jq -r '.enable_qmodem' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-qmodem=y" >> .config
            # QModem æ ¸å¿ƒ
            echo "CONFIG_PACKAGE_luci-compat=y" >> .config
            echo "CONFIG_PACKAGE_qmodem=y" >> .config
            # QModem é©±åŠ¨é€‰æ‹© - ä½¿ç”¨ Vendor é©±åŠ¨
            echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_vendor-qmi-wwan=y" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_generic-qmi-wwan is not set" >> .config
            # QModem IPv6 æ”¯æŒ
            echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_ndisc6=y" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_rdisc6 is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_no_ndisc_rdisc6 is not set" >> .config
            echo "CONFIG_PACKAGE_ndisc6=y" >> .config
            # QModem Quectel CM é€‰æ‹© - ä½¿ç”¨ Tom å®šåˆ¶ç‰ˆ
            echo "CONFIG_PACKAGE_luci-app-qmodem_USE_TOM_CUSTOMIZED_QUECTEL_CM=y" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_USING_QWRT_QUECTEL_CM_5G is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_USING_NORMAL_QUECTEL_CM is not set" >> .config
            echo "CONFIG_PACKAGE_quectel-CM-5G-M=y" >> .config
            # QModem ä¾èµ–å·¥å…·
            echo "CONFIG_PACKAGE_sms-tool_q=y" >> .config
            echo "CONFIG_PACKAGE_ubus-at-daemon=y" >> .config
            echo "CONFIG_PACKAGE_tom_modem=y" >> .config
            # çŸ­ä¿¡ç•Œé¢
            echo "CONFIG_PACKAGE_luci-app-qmodem-sms=y" >> .config
            # QModem Vendor QMI é©±åŠ¨
            echo "CONFIG_PACKAGE_kmod-qmi_wwan_q=y" >> .config
            echo "CONFIG_PACKAGE_kmod-qmi_wwan_f=y" >> .config
            echo "CONFIG_PACKAGE_kmod-qmi_wwan_s=y" >> .config
            # QModem MWAN (å¤šWANè´Ÿè½½å‡è¡¡)
            echo "CONFIG_PACKAGE_mwan3=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
            # å¦‚æžœåŒæ—¶å¯ç”¨äº† MWANï¼Œåˆ™å¯ç”¨ luci-app-qmodem-mwan
            if [ "$(jq -r '.enable_mwan' config/plugins.json 2>/dev/null || echo 'false')" = "true" ]; then
              echo "CONFIG_PACKAGE_luci-app-qmodem-mwan=y" >> .config
            fi
            # HQOS æ”¯æŒ
            echo "CONFIG_PACKAGE_mtkhqos_util=y" >> .config
          else
            disabled_pkgs+=("luci-app-qmodem-next" "luci-app-qmodem")
          fi

          # ç»Ÿä¸€ç¦ç”¨ä¸éœ€è¦çš„åŒ…
          all_disabled=("luci-app-wrtbwmon" "luci-app-rclone" "rclone" "rclone-ng" "rclone-webui-react" "${disabled_pkgs[@]}")
          for pkg in "${all_disabled[@]}"; do
            sed -i "/^CONFIG_PACKAGE_${pkg}=/d" .config
            echo "# CONFIG_PACKAGE_${pkg} is not set" >> .config
          done

          # è‡ªåŠ¨è§£æžä¾èµ–
          make defconfig

          echo "âœ… é…ç½®å®Œæˆ"

      - name: é¢„ä¸‹è½½å’Œé¢„æž„å»º
        run: |
          cd $SOURCE_DIR
          THREADS=$(nproc)
          
          # ä¸‹è½½ä¾èµ–ï¼ˆå¸¦é‡è¯•ï¼‰
          echo "ðŸ“¥ é¢„ä¸‹è½½æž„å»ºä¾èµ–..."
          find dl -size -1024c -delete 2>/dev/null || true
          for i in 1 2 3; do
            make download -j$THREADS && break || { find dl -size -1024c -delete 2>/dev/null || true; sleep 3; }
          done
          
          # é¢„æž„å»ºå·¥å…·é“¾
          echo "ðŸ”§ é¢„æž„å»ºå·¥å…·é“¾..."
          [ -d "staging_dir" ] && [ -n "$(ls -A staging_dir 2>/dev/null)" ] && echo "âœ… å·¥å…·é“¾å·²ç¼“å­˜" || make toolchain/install -j$THREADS || true

      - name: æ‰“åŒ…æºç 
        run: |
          echo "ðŸ“¦ æ‰“åŒ…æºç å’Œé…ç½®..."
          tar --exclude="$SOURCE_DIR/build_dir" --exclude="$SOURCE_DIR/tmp" -czf source.tar.gz $SOURCE_DIR $GITHUB_WORKSPACE/h5000m.extra.config $GITHUB_WORKSPACE/feeds.conf.default 2>/dev/null || true

      - name: ç”Ÿæˆæ ‡å‡†æ•°æ®æº (plugins.json)
        id: save-config
        run: |
          echo "ç”Ÿæˆæ ‡å‡†æ•°æ®æº (plugins.json)..."
          mkdir -p config
          
          # ä½¿ç”¨ jq è¿‡æ»¤æ‰€æœ‰ enable_ å¼€å¤´çš„å˜é‡ï¼Œåˆ›å»ºçº¯å‡€çš„ JSON æ–‡ä»¶
          CURRENT_CONFIG=$(jq -n '{ 
            enable_adguardhome: ${{ steps.set-env.outputs.enable_adguardhome }}, 
            enable_openclash: ${{ steps.set-env.outputs.enable_openclash }}, 
            enable_nikki: ${{ steps.set-env.outputs.enable_nikki }}, 
            enable_upnp: ${{ steps.set-env.outputs.enable_upnp }}, 
            enable_vlmcsd: ${{ steps.set-env.outputs.enable_vlmcsd }}, 
            enable_mosdns: ${{ steps.set-env.outputs.enable_mosdns }}, 
            enable_dockerman: ${{ steps.set-env.outputs.enable_dockerman }}, 
            enable_qmodem_next: ${{ steps.set-env.outputs.enable_qmodem_next }}, 
            enable_qmodem: ${{ steps.set-env.outputs.enable_qmodem }}, 
            enable_mwan: ${{ steps.set-env.outputs.enable_mwan }}, 
            enable_homeproxy: ${{ steps.set-env.outputs.enable_homeproxy }}, 
            enable_adbyby_plus: ${{ steps.set-env.outputs.enable_adbyby_plus }}, 
            enable_original_modem: ${{ steps.set-env.outputs.enable_original_modem }}, 
            enable_netspeedtest: ${{ steps.set-env.outputs.enable_netspeedtest }}, 
            enable_at_webserver: ${{ steps.set-env.outputs.enable_at_webserver }}, 
            enable_zerotier: ${{ steps.set-env.outputs.enable_zerotier }}, 
            enable_wrtbwmon: ${{ steps.set-env.outputs.enable_wrtbwmon }}, 
            enable_watchcat: ${{ steps.set-env.outputs.enable_watchcat }}, 
            enable_easytier: ${{ steps.set-env.outputs.enable_easytier }}, 
            enable_lucky: ${{ steps.set-env.outputs.enable_lucky }}, 
            enable_bandix: ${{ steps.set-env.outputs.enable_bandix }}, 
            enable_daed: ${{ steps.set-env.outputs.enable_daed }}
          }')
          
          # è¿‡æ»¤å‡º enable_ å¼€å¤´çš„å˜é‡å¹¶ä¿å­˜
          echo "$CURRENT_CONFIG" | jq 'with_entries(select(.key | startswith("enable_")))' > config/plugins.json
          
          echo "âœ… æ ‡å‡†æ•°æ®æºç”Ÿæˆå®Œæˆ"
          cat config/plugins.json

      - name: ç¼“å­˜æ’ä»¶é…ç½®
        uses: actions/cache/save@v4
        with:
          path: config/plugins.json
          key: plugin-config-${{ github.run_id }}

      - name: GitHub Summary å¯è§†åŒ–
        run: |
          echo "## ðŸš€ åŠŸèƒ½å¼€å¯æ¸…å•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ä»Ž config/plugins.json è¯»å–é…ç½®å¹¶ç”Ÿæˆæ‘˜è¦
          ENABLED_FEATURES=$(jq -r 'to_entries[] | select(.value == true or .value == "true") | .key' config/plugins.json)
          
          if [ -n "$ENABLED_FEATURES" ]; then
            while read -r key; do
              # æ ¼å¼åŒ–åç§°ï¼šåŽ»æŽ‰ enable_ï¼Œä¸‹åˆ’çº¿è½¬ç©ºæ ¼ï¼Œé¦–å­—æ¯å¤§å†™
              friendly_name=$(echo "$key" | sed 's/enable_//g' | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} END {print $0}')
              echo "- âœ… $friendly_name" >> $GITHUB_STEP_SUMMARY
            done <<< "$ENABLED_FEATURES"
          else
            echo "- ðŸ“¦ åŸºç¡€å›ºä»¶ï¼ˆæœªå¼€å¯é¢å¤–æ’ä»¶ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ è¯¦ç»†é…ç½®ï¼š" >> $GITHUB_STEP_SUMMARY
          cat config/plugins.json | jq -r '.' >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ ä¸´æ—¶é…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: build-configs
          path: config/

      - name: ä¸Šä¼ æºç 
        uses: actions/upload-artifact@v4
        with:
          name: source-${{ github.run_number }}
          path: source.tar.gz
          retention-days: 1

  build:
    needs: prepare
    runs-on: ubuntu-22.04
    steps:
      - name: ä¸‹è½½æºç 
        uses: actions/download-artifact@v4
        with:
          name: source-${{ github.run_number }}

      - name: è§£åŽ‹æºç 
        run: |
          echo "ðŸ“¦ è§£åŽ‹æºç ..."
          tar -xzf source.tar.gz
          echo "âœ… æºç è§£åŽ‹å®Œæˆ"

      - name: ä¸‹è½½ä¸´æ—¶é…ç½®
        uses: actions/download-artifact@v4
        with:
          name: build-configs
          path: config/

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          echo "ðŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y build-essential git ccache python3 python3-pip \
            libncurses5-dev libssl-dev libgmp3-dev libmbedtls-dev rustc cargo \
            golang-go autoconf automake libtool patch make gcc g++ gawk gettext unzip file wget
          
          # è®¾ç½® ccache
          export PATH="/usr/lib/ccache:$PATH"
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          echo "âœ… ç¼–è¯‘ä¾èµ–å®‰è£…å®Œæˆ"

      - name: æ·±åº¦æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          echo "ðŸ§¹ æ‰§è¡Œæ·±åº¦æ¸…ç†ä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´..."
          
          # åˆ é™¤ Docker èµ„æº
          docker rmi $(docker images -q) 2>/dev/null || true
          docker system prune -f 2>/dev/null || true
          
          # åˆ é™¤å¤§åž‹ç»„ä»¶
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php \
            /usr/local/share/boost /usr/share/swift /opt/hostedtoolcache /usr/local/.ghcup \
            /usr/local/graalvm /imagegeneration /usr/local/share /opt /var/cache/apt/archives/* \
            /etc/apt/sources.list.d/* 2>/dev/null || true
          
          # å¸è½½ä¸éœ€è¦çš„è½¯ä»¶åŒ…
          sudo apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* \
            google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* \
            mongodb* moby* snap* 2>/dev/null || true
          
          # æ¸…ç†åŒ…ç®¡ç†å™¨å’Œä¸´æ—¶æ–‡ä»¶
          sudo apt-get autoremove --purge -y && sudo apt-get clean && sudo apt-get autoclean
          sudo rm -rf /tmp/* /var/tmp/* /var/log/* ~/.cache/* 2>/dev/null || true
          
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "âœ… æ¸…ç†åŽå¯ç”¨ç£ç›˜ç©ºé—´: ${AVAIL_GB}GB"

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd $SOURCE_DIR
          THREADS=$(nproc)  # åŠ¨æ€ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ ¸å¿ƒï¼Œæé«˜æ•ˆçŽ‡
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘ (${THREADS} çº¿ç¨‹)..."
          echo "ðŸ“Š CCache ç»Ÿè®¡ (å¼€å§‹):"
          ccache -s || true
          
          START_TIME=$(date +%s)
          
          # è¡¥å……ä¸‹è½½ï¼ˆå¦‚æœ‰é—æ¼ï¼‰
          find dl -size -1024c -delete 2>/dev/null || true
          make download -j$THREADS || true
          
          # ç¼–è¯‘
          if make -j$THREADS IGNORE_ERRORS=n; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "âœ… ç¼–è¯‘æˆåŠŸ (è€—æ—¶: ${DURATION}s)"
            echo "ðŸ“Š CCache ç»Ÿè®¡ (ç»“æŸ):"
            ccache -s || true
          else
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹è°ƒè¯•..."
            make -j1 V=s || {
              echo "âŒ ç¼–è¯‘å¤±è´¥"
              exit 1
            }
          fi

      - name: æ‰“åŒ…äº§ç‰©
        run: |
          cd $SOURCE_DIR
          echo "ðŸ“¦ æ‰“åŒ…äº§ç‰©..."
          mkdir -p ../artifacts
          find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} ../artifacts/ \;
          cd ..
          tar -czf artifacts.tar.gz artifacts/

      - name: ç”Ÿæˆ Release å†…å®¹
        run: |
          cd $SOURCE_DIR
          echo "ðŸ”§ ä»Ž config/plugins.json ç”Ÿæˆ Release å†…å®¹..."
          
          # åˆ›å»º release_body.txt
          echo "ðŸŽ‰ **ImmortalWrt H5000M å›ºä»¶å·²æž„å»ºå®Œæˆ**" > release_body.txt
          echo "" >> release_body.txt
          echo "ðŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> release_body.txt
          echo "ðŸ”— è¿è¡Œ ID: ${{ github.run_id }}" >> release_body.txt
          echo "" >> release_body.txt
          echo "## ðŸš€ åŠŸèƒ½å¼€å¯æ¸…å•" >> release_body.txt
          echo "" >> release_body.txt
          
          # ä»Ž config/plugins.json è§£æžå¹¶ç”ŸæˆåŠŸèƒ½å¼€å¯æ¸…å•
          ENABLED_FEATURES=$(jq -r 'to_entries[] | select(.value == true or .value == "true") | .key' ../config/plugins.json)
          
          if [ -n "$ENABLED_FEATURES" ]; then
            while read -r key; do
              # æ ¼å¼åŒ–ä¸ºå‹å¥½åç§°
              friendly_name=$(echo "$key" | sed 's/enable_//g' | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} END {print $0}')
              echo "- âœ… $friendly_name" >> release_body.txt
            done <<< "$ENABLED_FEATURES"
          else
            echo "- ðŸ“¦ åŸºç¡€å›ºä»¶ï¼ˆæœªå¼€å¯é¢å¤–æ’ä»¶ï¼‰" >> release_body.txt
          fi
          
          echo "" >> release_body.txt
          echo "ï¿½ å›ºä»¶ä¿¡æ¯åŠä¸‹è½½åœ°å€è§ä¸‹æ–¹åˆ—è¡¨ã€‚" >> release_body.txt
          echo "" >> release_body.txt
          echo "ï¿½ ä¸‹è½½äº§ç‰©: è§ä¸‹æ–¹ Artifacts" >> release_body.txt
          
          # å¤åˆ¶åˆ°artifactsç›®å½•
          cp release_body.txt ../artifacts/
          echo "âœ… Releaseä¿¡æ¯ç”Ÿæˆå®Œæˆ"

      - name: éªŒè¯äº§ç‰©
        run: |
          echo "ðŸ” éªŒè¯äº§ç‰©..."
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          else
            echo "âœ… äº§ç‰©éªŒè¯é€šè¿‡"
            ls -lh artifacts/
          fi

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ github.run_number }}
          path: artifacts.tar.gz
          retention-days: 30

  release:
    needs: [prepare, build]
    runs-on: ubuntu-22.04
    if: success()
    steps:
      - name: ä¸‹è½½ä¸´æ—¶é…ç½®
        uses: actions/download-artifact@v4
        with:
          name: build-configs
          path: config/

      - name: ä¸‹è½½äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: artifacts-${{ github.run_number }}

      - name: è§£åŽ‹äº§ç‰©
        run: |
          echo "ðŸ“¦ è§£åŽ‹äº§ç‰©..."
          tar -xzf artifacts.tar.gz
          echo "âœ… äº§ç‰©è§£åŽ‹å®Œæˆ"

      - name: æ”¶é›†å’Œä¸Šä¼ äº§ç‰©
        run: |
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          fi

          # ä»Ž config/plugins.json ç”Ÿæˆ Release ä¿¡æ¯
          echo "ðŸ”§ ä»Ž config/plugins.json ç”Ÿæˆ Release ä¿¡æ¯..."
          
          # ç”Ÿæˆ Release ä¿¡æ¯
          echo "ðŸŽ‰ **ImmortalWrt H5000M å›ºä»¶å·²æž„å»ºå®Œæˆ**" > artifacts/release_body.txt
          echo "" >> artifacts/release_body.txt
          echo "ðŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> artifacts/release_body.txt
          echo "ðŸ”— è¿è¡Œ ID: ${{ github.run_id }}" >> artifacts/release_body.txt
          echo "" >> artifacts/release_body.txt
          echo "## ðŸš€ åŠŸèƒ½å¼€å¯æ¸…å•" >> artifacts/release_body.txt
          echo "" >> artifacts/release_body.txt
          
          # ä»Ž config/plugins.json è§£æžå¹¶ç”ŸæˆåŠŸèƒ½å¼€å¯æ¸…å•
          ENABLED_FEATURES=$(jq -r 'to_entries[] | select(.value == true or .value == "true") | .key' config/plugins.json)
          
          if [ -n "$ENABLED_FEATURES" ]; then
            while read -r key; do
              # æ ¼å¼åŒ–ä¸ºå‹å¥½åç§°
              friendly_name=$(echo "$key" | sed 's/enable_//g' | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} END {print $0}')
              echo "- âœ… $friendly_name" >> artifacts/release_body.txt
            done <<< "$ENABLED_FEATURES"
          else
            echo "- ðŸ“¦ åŸºç¡€å›ºä»¶ï¼ˆæœªå¼€å¯é¢å¤–æ’ä»¶ï¼‰" >> artifacts/release_body.txt
          fi
          
          echo "" >> artifacts/release_body.txt
          echo "ï¿½ ä¸‹è½½äº§ç‰©: è§ä¸‹æ–¹ Artifacts" >> artifacts/release_body.txt

          # ç”Ÿæˆæ¸…å•
          cat > artifacts/MANIFEST.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ImmortalWrt H5000M å›ºä»¶æž„å»ºä¿¡æ¯             â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ðŸ“… æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          ðŸ”— è¿è¡Œ ID: ${{ github.run_id }}
          ðŸ·ï¸  Build #: ${{ github.run_number }}

          EOF
          
          # ä»Ž config/plugins.json è§£æžå¹¶ç”ŸæˆåŠŸèƒ½å¼€å¯æ¸…å•åˆ° MANIFEST.txt
          echo "## ðŸš€ åŠŸèƒ½å¼€å¯æ¸…å•" >> artifacts/MANIFEST.txt
          echo "" >> artifacts/MANIFEST.txt
          
          if [ -n "$ENABLED_FEATURES" ]; then
            while read -r key; do
              # æ ¼å¼åŒ–ä¸ºå‹å¥½åç§°
              friendly_name=$(echo "$key" | sed 's/enable_//g' | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} END {print $0}')
              echo "- âœ… $friendly_name" >> artifacts/MANIFEST.txt
            done <<< "$ENABLED_FEATURES"
          else
            echo "- ðŸ“¦ åŸºç¡€å›ºä»¶ï¼ˆæœªå¼€å¯é¢å¤–æ’ä»¶ï¼‰" >> artifacts/MANIFEST.txt
          fi
          
          echo "" >> artifacts/MANIFEST.txt
          echo "ðŸ“¦ äº§ç‰©æ–‡ä»¶:" >> artifacts/MANIFEST.txt

          cd artifacts
          ls -lh | grep -v "^total" | awk '{print "  â€¢ " $9 " (" $5 ")"}' >> MANIFEST.txt

          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ"

      - name: ä¸Šä¼ æž„å»ºç»“æžœ
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-H5000M-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: h5000m-${{ github.run_number }}
          name: ImmortalWrt H5000M
          body_path: artifacts/release_body.txt
          files: |
            artifacts/*.bin
            artifacts/*.img.gz
            artifacts/MANIFEST.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}