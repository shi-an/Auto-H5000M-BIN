name: Build ImmortalWrt XR30

on:
  workflow_dispatch:
    inputs:
      enable_openclash:
        description: 'å¯ç”¨ OpenClash'
        required: false
        default: true
        type: boolean
      enable_netspeedtest:
        description: 'å¯ç”¨ netspeedtest'
        required: false
        default: true
        type: boolean
      enable_easytier:
        description: 'å¯ç”¨ easytier'
        required: false
        default: true
        type: boolean
      enable_lucky:
        description: 'å¯ç”¨ lucky'
        required: false
        default: true
        type: boolean
      enable_bandix:
        description: 'å¯ç”¨ Bandix'
        required: false
        default: true
        type: boolean
      enable_upnp:
        description: 'å¯ç”¨ UPnP'
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6.git
  REPO_BRANCH: openwrt-24.10-6.6
  CONFIG_URL: https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/refs/heads/openwrt-24.10-6.6/defconfig/mt7981-ax3000.config
  SOURCE_DIR: immortalwrt
  TZ: Asia/Shanghai

jobs:
  build_firmware:
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æ·±åº¦æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          echo "ğŸ§¹ æ‰§è¡Œæ·±åº¦æ¸…ç†ä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´..."
          docker rmi $(docker images -q) 2>/dev/null || true
          docker system prune -f 2>/dev/null || true
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php \
            /usr/local/share/boost /usr/share/swift /opt/hostedtoolcache /usr/local/.ghcup \
            /usr/local/graalvm /imagegeneration /usr/local/share /opt /var/cache/apt/archives/* \
            /etc/apt/sources.list.d/* 2>/dev/null || true
          sudo apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* \
            google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* \
            mongodb* moby* snap* 2>/dev/null || true
          sudo apt-get autoremove --purge -y && sudo apt-get clean && sudo apt-get autoclean
          sudo rm -rf /tmp/* /var/tmp/* /var/log/* ~/.cache/* 2>/dev/null || true
          
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "ğŸ’¾ å¯ç”¨ç£ç›˜ç©ºé—´: ${AVAIL_GB}GB"
          if [ "$AVAIL_GB" -lt 6 ]; then
            echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘6GB"
            exit 1
          fi

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ– (ä½¿ç”¨å®˜æ–¹åˆå§‹åŒ–è„šæœ¬)..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh | sudo bash
          
          # è®¾ç½® ccache
          echo "ğŸ“¦ è®¾ç½® ccache..."
          export PATH="/usr/lib/ccache:$PATH"
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          ccache --set-config=max_size=2G
          ccache --version || true

      - name: æ¢å¤æ’ä»¶é…ç½®ç¼“å­˜
        id: restore-config
        uses: actions/cache/restore@v4
        with:
          path: config/plugins.json
          key: plugins-config-xr30-latest
          restore-keys: |
            plugins-config-xr30-

      - name: æ¢å¤ç¼–è¯‘ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir
            ~/.ccache
          key: ${{ runner.os }}-build-xr30-${{ env.REPO_BRANCH }}-${{ hashFiles('feeds.conf.default', 'xr30.extra.config') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-build-xr30-${{ env.REPO_BRANCH }}-${{ hashFiles('feeds.conf.default', 'xr30.extra.config') }}-
            ${{ runner.os }}-build-xr30-${{ env.REPO_BRANCH }}-

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        id: set-env
        run: |
          echo "ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡..."
          mkdir -p config
          
          echo "ğŸ§­ æ‰‹åŠ¨è§¦å‘ï¼Œä¼˜å…ˆä½¿ç”¨ UI ä¼ å…¥çš„ inputs"
          ENABLE_OPENCLASH="${{ github.event.inputs.enable_openclash || 'false' }}"
          ENABLE_NETSPEEDTEST="${{ github.event.inputs.enable_netspeedtest || 'false' }}"
          ENABLE_EASYTIER="${{ github.event.inputs.enable_easytier || 'false' }}"
          ENABLE_LUCKY="${{ github.event.inputs.enable_lucky || 'false' }}"
          ENABLE_BANDIX="${{ github.event.inputs.enable_bandix || 'false' }}"
          ENABLE_UPNP="${{ github.event.inputs.enable_upnp || 'false' }}"
          
          # ç¡®ä¿æ‰€æœ‰å˜é‡éƒ½æœ‰å€¼ï¼ˆé»˜è®¤ä¸º falseï¼‰
          : ${ENABLE_OPENCLASH:=false}
          : ${ENABLE_NETSPEEDTEST:=false}
          : ${ENABLE_EASYTIER:=false}
          : ${ENABLE_LUCKY:=false}
          : ${ENABLE_BANDIX:=false}
          : ${ENABLE_UPNP:=false}
          
          # è¾“å‡ºé…ç½®åˆ° GITHUB_OUTPUT
          echo "enable_openclash=$ENABLE_OPENCLASH" >> $GITHUB_OUTPUT
          echo "enable_netspeedtest=$ENABLE_NETSPEEDTEST" >> $GITHUB_OUTPUT
          echo "enable_easytier=$ENABLE_EASYTIER" >> $GITHUB_OUTPUT
          echo "enable_lucky=$ENABLE_LUCKY" >> $GITHUB_OUTPUT
          echo "enable_bandix=$ENABLE_BANDIX" >> $GITHUB_OUTPUT
          echo "enable_upnp=$ENABLE_UPNP" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºæœ€ç»ˆé…ç½®
          echo "ğŸ“‹ æœ€ç»ˆä½¿ç”¨çš„é…ç½® (XR30):"
          echo "â€¢ OpenClash: $ENABLE_OPENCLASH"
          echo "â€¢ NetSpeedTest: $ENABLE_NETSPEEDTEST"
          echo "â€¢ EasyTier: $ENABLE_EASYTIER"
          echo "â€¢ Lucky: $ENABLE_LUCKY"
          echo "â€¢ Bandix: $ENABLE_BANDIX"
          echo "â€¢ UPnP: $ENABLE_UPNP"

      - name: ç”Ÿæˆæ ‡å‡†æ•°æ®æº plugins.json
        run: |
          mkdir -p config
          echo "ğŸ§¾ ç”Ÿæˆæ ‡å‡† plugins.json (SSOT)"
          CURRENT_JSON=$(cat << 'EOF'
          {
            "enable_openclash": "${{ steps.set-env.outputs.enable_openclash }}",
            "enable_netspeedtest": "${{ steps.set-env.outputs.enable_netspeedtest }}",
            "enable_easytier": "${{ steps.set-env.outputs.enable_easytier }}",
            "enable_lucky": "${{ steps.set-env.outputs.enable_lucky }}",
            "enable_bandix": "${{ steps.set-env.outputs.enable_bandix }}",
            "enable_upnp": "${{ steps.set-env.outputs.enable_upnp }}"
          }
          EOF
          )
          # ä½¿ç”¨ jq ç”Ÿæˆè§„èŒƒçš„ plugins.json
          echo "$CURRENT_JSON" | jq '
            with_entries(select(.key | startswith("enable_"))
            | .value = (
                if (.value|type)=="string" then 
                  (.value | ascii_downcase == "true")
                else 
                  .value 
                end
              )
            )' > config/plugins.json
          echo "âœ… plugins.json å·²ç”Ÿæˆ"
          cat config/plugins.json

      - name: æºç å’Œä¾èµ–å‡†å¤‡
        run: |
          # è°ƒè¯•ï¼šæ£€æŸ¥ config ç›®å½•
          echo "ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥ config ç›®å½•"
          ls -R "$GITHUB_WORKSPACE/config" || echo "config ç›®å½•ä¸å­˜åœ¨"

          # æ£€æŸ¥å¹¶å‡†å¤‡æºç 
          if [ ! -d "$SOURCE_DIR" ] || [ ! -d "$SOURCE_DIR/.git" ]; then
            echo "ğŸ“¥ å…‹éš†æºç ..."
            rm -rf "$SOURCE_DIR" 2>/dev/null || true
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
          else
            echo "ğŸ”„ æ£€æŸ¥æºç æ›´æ–°..."
            cd $SOURCE_DIR
            CURRENT_BRANCH=$(git branch --show-current)
            if [ "$CURRENT_BRANCH" != "$REPO_BRANCH" ]; then
              echo "åˆ†æ”¯ä¸åŒï¼Œé‡æ–°å…‹éš†..."
              cd ..
              rm -rf "$SOURCE_DIR"
              git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
            else
              git fetch origin $REPO_BRANCH
              LOCAL_COMMIT=$(git rev-parse HEAD)
              REMOTE_COMMIT=$(git rev-parse FETCH_HEAD)
              if [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
                echo "æœ‰æ›´æ–°ï¼Œé‡ç½®åˆ°æœ€æ–°..."
                git reset --hard FETCH_HEAD
              else
                echo "æºç å·²æ˜¯æœ€æ–°"
              fi
            fi
            cd ..
          fi

          # è®¾ç½® feeds
          cd $SOURCE_DIR
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
          fi

          echo "ğŸ“‹ å½“å‰ feeds.conf.default å†…å®¹:"
          cat feeds.conf.default

          echo "ğŸ§¹ æ¸…ç† feeds ç¼“å­˜..."
          rm -rf tmp/.config* tmp/.packageinfo tmp/.targetinfo tmp/info tmp/.feeds* 2>/dev/null || true
          
          echo "ğŸ”„ æ›´æ–° feeds..."
          ./scripts/feeds update -a -j $(nproc) || true
          ./scripts/feeds install -a -f -j $(nproc) || true
          
          echo "âœ… feeds å¤„ç†å®Œæˆ"

      - name: å…‹éš†ç¬¬ä¸‰æ–¹ä»“åº“
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¥ å…‹éš†ç¬¬ä¸‰æ–¹ä»“åº“..."
          
          NST_ENABLED=$(jq -r '.enable_netspeedtest // false' "$GITHUB_WORKSPACE/config/plugins.json")
          if [[ "$NST_ENABLED" == "True" || "$NST_ENABLED" == "true" ]] && [ ! -d "package/luci-app-netspeedtest" ]; then
            git clone https://github.com/sirpdboy/luci-app-netspeedtest.git -b master package/luci-app-netspeedtest
          fi
          
          LUCKY_ENABLED=$(jq -r '.enable_lucky // false' "$GITHUB_WORKSPACE/config/plugins.json")
          if [[ "$LUCKY_ENABLED" == "True" || "$LUCKY_ENABLED" == "true" ]] && [ ! -d "package/luci-app-lucky" ]; then
            git clone https://github.com/gdy666/luci-app-lucky.git -b main package/luci-app-lucky
          fi

      - name: ä¸‹è½½ Release è½¯ä»¶åŒ…å¹¶å‡†å¤‡è‡ªåŠ¨å®‰è£…
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd $SOURCE_DIR
          INSTALL_DIR="files/root/ipks"
          mkdir -p $INSTALL_DIR
          mkdir -p files/etc/uci-defaults
          
          ET_ENABLED=$(jq -r '.enable_easytier // false' "$GITHUB_WORKSPACE/config/plugins.json")
          if [[ "$ET_ENABLED" == "True" || "$ET_ENABLED" == "true" ]]; then
            ET_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/EasyTier/luci-app-easytier/releases/latest | jq -r '.assets[] | select(.name | contains("aarch64_cortex-a53") and contains("22.03.7") and (contains("SNAPSHOT") | not)).browser_download_url // empty' | head -1)
            if [ -z "$ET_URL" ]; then
              ET_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/EasyTier/luci-app-easytier/releases/latest | jq -r '.assets[] | select(.name | contains("aarch64_cortex-a53") and (contains("SNAPSHOT") | not)).browser_download_url // empty' | head -1)
            fi
            if [ -n "$ET_URL" ]; then
              wget -qO /tmp/easytier.zip "$ET_URL"
              unzip -o /tmp/easytier.zip -d $INSTALL_DIR/
            fi
          fi

          if [ "$(jq -r '.enable_bandix // false' "$GITHUB_WORKSPACE/config/plugins.json")" = "true" ]; then
            BD_CORE_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/timsaya/openwrt-bandix/releases/latest | jq -r '.assets[] | select(.name | contains("bandix") and contains("aarch64_cortex-a53") and contains(".ipk")).browser_download_url // empty' | head -1)
            BD_LUCI_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/timsaya/luci-app-bandix/releases/latest | jq -r '.assets[] | select(.name | contains("luci-app-bandix") and contains(".ipk")).browser_download_url // empty' | head -1)
            BD_I18N_URL=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/timsaya/luci-app-bandix/releases/latest | jq -r '.assets[] | select(.name | contains("luci-i18n-bandix-zh-cn") and contains(".ipk")).browser_download_url // empty' | head -1)
            
            [ -n "$BD_CORE_URL" ] && wget -P $INSTALL_DIR/ "$BD_CORE_URL"
            [ -n "$BD_LUCI_URL" ] && wget -P $INSTALL_DIR/ "$BD_LUCI_URL"
            [ -n "$BD_I18N_URL" ] && wget -P $INSTALL_DIR/ "$BD_I18N_URL"
          fi

          cat > files/etc/uci-defaults/99-install-custom-ipks << 'EOF'
          #!/bin/sh
          if [ -d "/root/ipks" ]; then
            opkg install /root/ipks/easytier*.ipk
            opkg install /root/ipks/bandix*.ipk
            opkg install /root/ipks/luci-app-*.ipk
            opkg install /root/ipks/luci-i18n-*.ipk
            rm -rf /root/ipks
          fi
          exit 0
          EOF
          chmod +x files/etc/uci-defaults/99-install-custom-ipks

      - name: ä¿®å¤ä¾èµ–å’Œè¡¥ä¸
        run: |
          cd $SOURCE_DIR
          echo "ğŸ”§ åº”ç”¨è¡¥ä¸å’Œä¿®å¤ä¾èµ–..."
          
          # ä¿®å¤ ebtables
          EBTABLES_MAKEFILE="package/network/utils/ebtables/Makefile"
          if [ -f "$EBTABLES_MAKEFILE" ]; then
            sed -i 's|https://git.netfilter.org/ebtables|https://github.com/netfilter/ebtables.git|g' "$EBTABLES_MAKEFILE"
            sed -i 's|git://git.netfilter.org/ebtables|https://github.com/netfilter/ebtables.git|g' "$EBTABLES_MAKEFILE"
            sed -i 's|PKG_MIRROR_HASH:=.*|PKG_MIRROR_HASH:=skip|g' "$EBTABLES_MAKEFILE"
          fi
          
          rm -rf package/feeds/packages/{exim,onionshare-cli,python-zope-event,python-zope-interface,python-gevent,python-twisted} 2>/dev/null || true

          [ -f "package/mtk/drivers/mt_hwifi/Makefile" ] && sed -i 's/+kmod-mt_wifi_osal//g' "package/mtk/drivers/mt_hwifi/Makefile" || true

          # OpenClash Kernel
          if [ "$(jq -r '.enable_openclash // false' "$GITHUB_WORKSPACE/config/plugins.json")" = "true" ]; then
            mkdir -p feeds/luci/applications/luci-app-openclash/root/etc/openclash/core
            core_path="feeds/luci/applications/luci-app-openclash/root/etc/openclash/core"
            goe_path="feeds/luci/applications/luci-app-openclash/root/etc/openclash"
            wget -qO- https://raw.githubusercontent.com/vernesong/OpenClash/core/master/meta/clash-linux-arm64.tar.gz | tar xOvz > $core_path/clash_meta
            wget -qO- https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat > $goe_path/GeoIP.dat
            wget -qO- https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat > $goe_path/GeoSite.dat
            chmod +x $core_path/clash_meta
          fi

      - name: ä¿®æ”¹é»˜è®¤LAN IPåœ°å€
        run: |
          cd $SOURCE_DIR
          sed -i 's/192.168.6.1/192.168.31.1/g' package/base-files/files/bin/config_generate

      - name: é…ç½®æ„å»º
        run: |
          cd $SOURCE_DIR
          echo "âš™ï¸ é…ç½®æ„å»ºé€‰é¡¹..."
          CFG="$GITHUB_WORKSPACE/config/plugins.json"

          # ä¸‹è½½åŸºç¡€é…ç½®
          curl -fsSL "$CONFIG_URL" -o base.config || {
            [ -f "defconfig/mt7987_mt7992.config" ] && cp defconfig/mt7987_mt7992.config base.config
          }
          cat base.config > .config

          # æ˜¾å¼æ·»åŠ  CMCC XR30 (cmcc_xr30-nand) è®¾å¤‡æ”¯æŒ
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_cmcc_xr30-nand=y" >> .config

          echo "ğŸ”§ åŸºäº plugins.json å¾ªç¯ç”Ÿæˆ .config..."
          TRUE_KEYS=$(jq -r 'to_entries | map(select(.key | startswith("enable_")) | select(.value == true or .value == "true") | .key) | join(" ")' "$CFG")
          
          for key in $TRUE_KEYS; do
            name="${key#enable_}"
            case "$name" in
              easytier) ;;
              bandix)
                echo "CONFIG_PACKAGE_zoneinfo-all=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-core=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-europe=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-africa=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-america=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-poles=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-asia=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-atlantic=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-australia-nz=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-pacific=y" >> .config
                echo "CONFIG_PACKAGE_zoneinfo-indian=y" >> .config
                echo "CONFIG_PACKAGE_libnetfilter-queue1=y" >> .config
                echo "CONFIG_PACKAGE_libnetfilter-cttimeout1=y" >> .config
                echo "CONFIG_PACKAGE_libnetfilter-cthelper0=y" >> .config
                echo "CONFIG_PACKAGE_conntrack=y" >> .config
                echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
                echo "CONFIG_PACKAGE_libstdcpp=y" >> .config
                echo "CONFIG_PACKAGE_libpthread=y" >> .config
                echo "CONFIG_PACKAGE_librt=y" >> .config
                ;;
              openclash)
                echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
                ;;
              netspeedtest)
                echo "CONFIG_PACKAGE_luci-app-netspeedtest=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-netspeedtest-zh-cn=y" >> .config
                ;;
              lucky)
                echo "CONFIG_PACKAGE_luci-app-lucky=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-lucky-zh-cn=y" >> .config
                ;;
              upnp)
                echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> .config
                ;;
              *)
                echo "CONFIG_PACKAGE_luci-app-${name}=y" >> .config
                ;;
            esac
          done

          # åº”ç”¨é¢å¤–é…ç½®
          if [ -f "$GITHUB_WORKSPACE/xr30.extra.config" ]; then
            cat "$GITHUB_WORKSPACE/xr30.extra.config" >> .config
          fi

          all_disabled=("luci-theme-bootstrap-mod" "luci-app-wrtbwmon" "luci-app-eqos-mtk" "luci-i18n-eqos-mtk-zh-cn" "luci-app-sms-tool-lite" "luci-app-3ginfo-lite")
          for pkg in "${all_disabled[@]}"; do
             sed -i "/^CONFIG_PACKAGE_${pkg}=/d" .config
             echo "# CONFIG_PACKAGE_${pkg} is not set" >> .config
          done

          make defconfig

      - name: ä¸Šä¼ æ„å»ºé…ç½® Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-configs-xr30
          path: config/
          retention-days: 7

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd $SOURCE_DIR
          THREADS=$(nproc)
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "ğŸ“¥ ä¸‹è½½æ„å»ºä¾èµ–..."
          find dl -size -1024c -delete 2>/dev/null || true
          make download -j$THREADS V=s || { find dl -size -1024c -delete 2>/dev/null || true; make download -j1 V=s; }
          
          echo "ğŸ”§ é¢„æ„å»ºå·¥å…·é“¾..."
          [ -d "staging_dir" ] && [ -n "$(ls -A staging_dir 2>/dev/null)" ] && echo "âœ… å·¥å…·é“¾å·²ç¼“å­˜" || make toolchain/install -j$THREADS || true
          
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ (${THREADS} çº¿ç¨‹)..."
          if make -j$THREADS IGNORE_ERRORS=n; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹è°ƒè¯•..."
            make -j1 V=s || exit 1
          fi

      - name: æ‰“åŒ…äº§ç‰©
        run: |
          cd $SOURCE_DIR
          mkdir -p ../artifacts
          find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} ../artifacts/ \;
          cd ..
          tar -czf artifacts.tar.gz artifacts/

      - name: åŠ¨æ€ç”ŸæˆReleaseä¿¡æ¯
        run: |
          cd $SOURCE_DIR
          echo "ğŸ‰ **ImmortalWrt XR30 å›ºä»¶å·²æ„å»ºå®Œæˆ**" > release_body.md
          echo "" >> release_body.md
          echo "ğŸ“… æ—¶é—´: ${{ github.event.repository.updated_at }}" >> release_body.md
          echo "ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}" >> release_body.md
          echo "" >> release_body.md
          echo "**âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:**" >> release_body.md
          
          jq -r 'to_entries | map(select(.key | startswith("enable_")) | select(.value == true or .value == "true") | .key) | .[]' "$GITHUB_WORKSPACE/config/plugins.json" | sed 's/^enable_//;s/_/ /g' | awk '{for(i=1;i<=NF;i++)sub(/./,toupper(substr($0,i,1)),$i)}1' | sed 's/^/- âœ… /' >> release_body.md
          
          cp release_body.md ../artifacts/

      - name: éªŒè¯äº§ç‰©
        run: |
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          fi
          ls -lh artifacts/

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-xr30-${{ github.run_number }}
          path: artifacts.tar.gz
          retention-days: 30

      - name: ç¼“å­˜æ’ä»¶é…ç½®ä¿å­˜
        uses: actions/cache/save@v4
        if: always()
        with:
          path: config/plugins.json
          key: plugins-config-xr30-${{ github.run_id }}

  release:
    needs: build_firmware
    runs-on: ubuntu-22.04
    if: success()
    steps:
      - name: ä¸‹è½½æ„å»ºé…ç½®
        uses: actions/download-artifact@v4
        with:
          name: build-configs-xr30
          path: config

      - name: ä¸‹è½½äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: artifacts-xr30-${{ github.run_number }}

      - name: è§£å‹äº§ç‰©
        run: |
          tar -xzf artifacts.tar.gz

      - name: æ”¶é›†å’Œä¸Šä¼ äº§ç‰©
        run: |
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"; exit 1
          fi

          echo "ğŸ‰ **ImmortalWrt XR30 å›ºä»¶å·²æ„å»ºå®Œæˆ**" > artifacts/release_body.md
          echo "" >> artifacts/release_body.md
          echo "ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> artifacts/release_body.md
          echo "ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}" >> artifacts/release_body.md
          echo "" >> artifacts/release_body.md
          echo "**âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:**" >> artifacts/release_body.md
          
          jq -r 'to_entries | map(select(.key | startswith("enable_")) | select(.value == true or .value == "true") | .key) | .[]' "$GITHUB_WORKSPACE/config/plugins.json" | sed 's/^enable_//;s/_/ /g' | awk '{for(i=1;i<=NF;i++)sub(/./,toupper(substr($0,i,1)),$i)}1' | sed 's/^/- âœ… /' >> artifacts/release_body.md
          
          cat > artifacts/MANIFEST.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ImmortalWrt XR30 å›ºä»¶æ„å»ºä¿¡æ¯               â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“… æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}
          ğŸ·ï¸  Build #: ${{ github.run_number }}
          EOF
          
          echo "" >> artifacts/MANIFEST.txt
          echo "ğŸ“¦ äº§ç‰©æ–‡ä»¶:" >> artifacts/MANIFEST.txt
          cd artifacts
          ls -lh | grep -v "^total" | awk '{print "  â€¢ " $9 " (" $5 ")"}' >> MANIFEST.txt

      - name: ä¸Šä¼ æ„å»ºç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-XR30-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: xr30-${{ github.run_number }}
          name: ImmortalWrt XR30
          body_path: artifacts/release_body.md
          files: |
            artifacts/*.bin
            artifacts/*.img.gz
            artifacts/MANIFEST.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
